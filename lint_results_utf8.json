[{"filePath":"F:\\WendelWenKey\\src\\components\\EditProfileDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[708,711],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[708,711],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2848,2851],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2848,2851],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\nimport { supabase } from '@/integrations/supabase/client';\nimport { useToast } from '@/hooks/use-toast';\nimport { Upload, Loader2 } from 'lucide-react';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { toTitleCase } from '@/lib/utils';\n\ninterface EditProfileDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  profile: any;\n  onProfileUpdated: () => void;\n}\n\nexport function EditProfileDialog({ open, onOpenChange, profile, onProfileUpdated }: EditProfileDialogProps) {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [fullName, setFullName] = useState(profile?.full_name || '');\n  const [avatarFile, setAvatarFile] = useState<File | null>(null);\n  const [avatarPreview, setAvatarPreview] = useState(profile?.avatar_url || '');\n  const [loading, setLoading] = useState(false);\n\n  useEffect(() => {\n    if (profile) {\n      setFullName(profile.full_name || '');\n      setAvatarPreview(profile.avatar_url || '');\n    }\n  }, [profile]);\n\n  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      setAvatarFile(file);\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setAvatarPreview(reader.result as string);\n      };\n      reader.readAsDataURL(file);\n    }\n  };\n\n  const handleSave = async () => {\n    if (!user) return;\n\n    setLoading(true);\n    try {\n      let avatarUrl = profile?.avatar_url;\n\n      // Upload avatar if a new file was selected\n      if (avatarFile) {\n        const fileExt = avatarFile.name.split('.').pop();\n        const fileName = `avatar-${Date.now()}.${fileExt}`;\n        const filePath = `${user.id}/${fileName}`;\n\n        const { error: uploadError } = await supabase.storage\n          .from('avatars')\n          .upload(filePath, avatarFile, {\n            upsert: true,\n            contentType: avatarFile.type\n          });\n\n        if (uploadError) throw uploadError;\n        avatarUrl = filePath;\n      }\n\n      // Update profile\n      const { error: updateError } = await supabase\n        .from('profiles')\n        .update({\n          full_name: fullName,\n          avatar_url: avatarUrl\n        })\n        .eq('id', user.id);\n\n      if (updateError) throw updateError;\n\n      toast({\n        title: toTitleCase('Perfil atualizado'),\n        description: toTitleCase('Suas informa├º├Áes foram salvas com sucesso.'),\n      });\n\n      onProfileUpdated();\n      onOpenChange(false);\n    } catch (error: any) {\n      console.error('Erro ao atualizar perfil:', error);\n      toast({\n        title: 'Erro',\n        description: toTitleCase(error.message || 'N├úo foi poss├¡vel atualizar o perfil.'),\n        variant: 'destructive',\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-[425px]\">\n        <DialogHeader>\n          <DialogTitle>{toTitleCase('Editar Perfil')}</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-4 py-4\">\n          <div className=\"flex flex-col items-center gap-4\">\n            <Avatar className=\"w-24 h-24\">\n              <AvatarImage src={avatarPreview} alt={fullName} />\n              <AvatarFallback className=\"bg-primary text-primary-foreground text-2xl\">\n                {fullName?.split(' ').map((n: string) => n[0]).join('').slice(0, 2).toUpperCase()}\n              </AvatarFallback>\n            </Avatar>\n            <div className=\"flex flex-col items-center gap-4\">\n              <Label className=\"text-sm font-medium\">{toTitleCase('Foto do Perfil')}</Label>\n              <div className=\"relative group\">\n                <Label htmlFor=\"avatar\" className=\"cursor-pointer\">\n                  <div className=\"flex items-center gap-2 px-4 py-2 border rounded-md hover:bg-accent transition-colors\">\n                    <Upload className=\"w-4 h-4\" />\n                    <span className=\"text-sm\">Alterar foto</span>\n                  </div>\n                  <Input\n                    id=\"avatar\"\n                    type=\"file\"\n                    accept=\"image/*\"\n                    className=\"hidden\"\n                    onChange={handleAvatarChange}\n                  />\n                </Label>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"fullName\">{toTitleCase('Nome Completo')}</Label>\n            <Input\n              id=\"fullName\"\n              value={fullName}\n              onChange={(e) => setFullName(e.target.value)}\n              placeholder=\"Digite seu nome completo\"\n            />\n          </div>\n        </div>\n\n        <div className=\"flex justify-end gap-2\">\n          <Button\n            variant=\"outline\"\n            onClick={() => onOpenChange(false)}\n            disabled={loading}\n          >\n            {toTitleCase('Cancelar')}\n          </Button>\n          <Button onClick={handleSave} disabled={loading}>\n            {loading ? (\n              <>\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                {toTitleCase('Salvando...')}\n              </>\n            ) : (\n              toTitleCase('Salvar Altera├º├Áes')\n            )}\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"F:\\WendelWenKey\\src\\contexts\\AuthContext.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'applySession'. Either include it or remove the dependency array.","line":215,"column":6,"nodeType":"ArrayExpression","endLine":215,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [applySession, navigate]","fix":{"range":[6999,7009],"text":"[applySession, navigate]"}}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":242,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":242,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useEffect, useState, ReactNode, useRef } from 'react';\r\nimport { User, Session } from '@supabase/supabase-js';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useNavigate } from 'react-router-dom';\r\n\r\nexport interface Profile {\r\n  id: string;\r\n  full_name: string;\r\n  email: string;\r\n  is_active: boolean;\r\n  permission_type: 'user' | 'manager' | 'admin';\r\n  company_id: string | null;\r\n  avatar_url: string | null;\r\n}\r\n\r\ninterface AuthContextType {\r\n  user: User | null;\r\n  profile: Profile | null;\r\n  session: Session | null;\r\n  loading: boolean;\r\n  signOut: () => Promise<void>;\r\n  refreshProfile: () => Promise<void>;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nexport function AuthProvider({ children }: { children: ReactNode }) {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [profile, setProfile] = useState<Profile | null>(null);\r\n  const [session, setSession] = useState<Session | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const navigate = useNavigate();\r\n\r\n  // Refs to track mounted state and whether a confirmed session exists\r\n  const mountedRef = useRef(true);\r\n  const hasConfirmedSessionRef = useRef(false);\r\n\r\n  const fetchProfile = async (userId: string, retryCount = 0): Promise<void> => {\r\n    if (!mountedRef.current) return;\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('profiles')\r\n        .select('id, full_name, email, is_active, company_id, avatar_url, permission_type')\r\n        .eq('id', userId)\r\n        .maybeSingle();\r\n\r\n      if (!mountedRef.current) return;\r\n\r\n      if (error) {\r\n        console.error('Error fetching profile:', error);\r\n        if (retryCount < 3) {\r\n          setTimeout(() => fetchProfile(userId, retryCount + 1), 1000 * (retryCount + 1));\r\n          return;\r\n        }\r\n        return;\r\n      }\r\n\r\n      if (data) {\r\n        let avatar_url = data.avatar_url;\r\n        if (avatar_url && !avatar_url.startsWith('http')) {\r\n          const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(avatar_url);\r\n          avatar_url = urlData.publicUrl;\r\n        }\r\n\r\n        if (mountedRef.current) {\r\n          setProfile({\r\n            ...data,\r\n            avatar_url,\r\n            permission_type: (data.permission_type as Profile['permission_type']) || 'user',\r\n          } as Profile);\r\n        }\r\n      }\r\n    } catch (err) {\r\n      console.error('Unexpected error fetching profile:', err);\r\n      if (retryCount < 3) {\r\n        setTimeout(() => fetchProfile(userId, retryCount + 1), 1000 * (retryCount + 1));\r\n      }\r\n    }\r\n  };\r\n\r\n  const refreshProfile = async () => {\r\n    if (user) {\r\n      await fetchProfile(user.id);\r\n    }\r\n  };\r\n\r\n  const applySession = async (nextSession: Session | null) => {\r\n    if (!mountedRef.current) return;\r\n\r\n    setSession(nextSession);\r\n    const currentUser = nextSession?.user ?? null;\r\n    setUser(currentUser);\r\n\r\n    if (currentUser) {\r\n      hasConfirmedSessionRef.current = true;\r\n      await fetchProfile(currentUser.id);\r\n    } else {\r\n      hasConfirmedSessionRef.current = false;\r\n      setProfile(null);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    mountedRef.current = true;\r\n\r\n    // Control flag to ensure we don't call setLoading(false) before we have a definitive answer\r\n    let initialized = false;\r\n\r\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(\r\n      async (event, nextSession) => {\r\n        if (!mountedRef.current) return;\r\n\r\n        console.log(`[Auth] onAuthStateChange event: ${event}`, nextSession?.user?.id);\r\n\r\n        // We only call applySession if the session actually changed or if it's the first time\r\n        await applySession(nextSession);\r\n\r\n        if (!initialized) {\r\n          initialized = true;\r\n          setLoading(false);\r\n        }\r\n\r\n        if (event === 'PASSWORD_RECOVERY') {\r\n          navigate('/reset-password');\r\n        }\r\n      }\r\n    );\r\n\r\n    const initializeAuth = async () => {\r\n      try {\r\n        // getSession is the definitive way to check current state on mount\r\n        const { data: { session }, error } = await supabase.auth.getSession();\r\n\r\n        if (error) {\r\n          console.error('[Auth] getSession error:', error);\r\n        }\r\n\r\n        if (!mountedRef.current) return;\r\n\r\n        // If onAuthStateChange hasn't already handled it\r\n        if (!initialized) {\r\n          if (session) {\r\n            await applySession(session);\r\n          } else {\r\n            // Check for potential stored session as a backup (compatibility with legacy code if any)\r\n            try {\r\n              const stored = localStorage.getItem('sb-auth-session');\r\n              if (stored) {\r\n                const storedSession = JSON.parse(stored);\r\n                if (storedSession?.access_token) {\r\n                  const { data: refreshData } = await supabase.auth.setSession({\r\n                    access_token: storedSession.access_token,\r\n                    refresh_token: storedSession.refresh_token,\r\n                  });\r\n                  if (refreshData.session) {\r\n                    await applySession(refreshData.session);\r\n                    initialized = true;\r\n                    setLoading(false);\r\n                    return;\r\n                  }\r\n                }\r\n              }\r\n            } catch (e) {\r\n              console.warn('[Auth] localStorage recovery attempt failed:', e);\r\n            }\r\n            await applySession(null);\r\n          }\r\n          initialized = true;\r\n          setLoading(false);\r\n        }\r\n      } catch (err) {\r\n        console.error('[Auth] initializeAuth error:', err);\r\n        if (!initialized && mountedRef.current) {\r\n          await applySession(null);\r\n          initialized = true;\r\n          setLoading(false);\r\n        }\r\n      }\r\n    };\r\n\r\n    initializeAuth();\r\n\r\n    const handleVisibilityOrFocus = async () => {\r\n      if (!mountedRef.current || !hasConfirmedSessionRef.current) return;\r\n\r\n      try {\r\n        const { data: { session } } = await supabase.auth.getSession();\r\n        if (session && mountedRef.current) {\r\n          setSession(session);\r\n          setUser(session.user);\r\n        }\r\n      } catch (err) {\r\n        console.warn('[Auth] Silent session refresh failed:', err);\r\n      }\r\n    };\r\n\r\n    window.addEventListener('focus', handleVisibilityOrFocus);\r\n    document.addEventListener('visibilitychange', () => {\r\n      if (document.visibilityState === 'visible') handleVisibilityOrFocus();\r\n    });\r\n\r\n    // Start automatic token refresh\r\n    try {\r\n      supabase.auth.startAutoRefresh();\r\n    } catch (err) {\r\n      console.warn('[Auth] startAutoRefresh failed:', err);\r\n    }\r\n\r\n    return () => {\r\n      mountedRef.current = false;\r\n      subscription.unsubscribe();\r\n      window.removeEventListener('focus', handleVisibilityOrFocus);\r\n      document.removeEventListener('visibilitychange', handleVisibilityOrFocus);\r\n    };\r\n  }, [navigate]);\r\n\r\n  const signOut = async () => {\r\n    try {\r\n      hasConfirmedSessionRef.current = false;\r\n      await supabase.auth.signOut();\r\n    } catch (error) {\r\n      console.error('Error signing out:', error);\r\n    } finally {\r\n      setProfile(null);\r\n      setSession(null);\r\n      setUser(null);\r\n      localStorage.removeItem('sb-auth-session');\r\n      localStorage.removeItem('selectedCompanyId');\r\n      localStorage.removeItem('selectedCompany');\r\n      sessionStorage.clear();\r\n      navigate('/auth', { replace: true });\r\n    }\r\n  };\r\n\r\n  return (\r\n    <AuthContext.Provider value={{ user, profile, session, loading, signOut, refreshProfile }}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useAuth() {\r\n  const context = useContext(AuthContext);\r\n  if (context === undefined) {\r\n    throw new Error('useAuth must be used within an AuthProvider');\r\n  }\r\n  return context;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"F:\\WendelWenKey\\src\\contexts\\CompanyContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":107,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":107,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useState, ReactNode, useEffect, useRef } from 'react';\nimport { useAuth } from './AuthContext';\nimport { supabase } from '@/integrations/supabase/client';\n\r\nexport interface Company {\r\n  id: string;\r\n  name: string;\r\n  is_active?: boolean;\r\n}\r\n\r\ninterface CompanyContextType {\r\n  selectedCompany: Company | null;\r\n  selectedCompanyId: string | null;\r\n  setSelectedCompany: (company: Company | null) => void;\r\n}\r\n\r\nconst CompanyContext = createContext<CompanyContextType | undefined>(undefined);\r\n\r\nexport function CompanyProvider({ children }: { children: ReactNode }) {\n  const { profile } = useAuth();\n  const [selectedCompany, setSelectedCompany] = useState<Company | null>(() => {\n    try {\n      const saved = localStorage.getItem('selectedCompany');\n      if (saved) {\n        return JSON.parse(saved);\n      }\r\n\r\n      // Fallback for migration from ID-only storage\r\n      const legacyId = localStorage.getItem('selectedCompanyId');\r\n      if (legacyId) {\r\n        return { id: legacyId, name: 'Carregando...' };\r\n      }\r\n    } catch (e) {\r\n      console.error('Error parsing selectedCompany from localStorage', e);\r\n    }\n    return null;\n  });\n  const autoSelectLock = useRef<{ userId: string | null; applied: boolean }>({\n    userId: null,\n    applied: false,\n  });\n\n  useEffect(() => {\n    if (selectedCompany) {\n      localStorage.setItem('selectedCompany', JSON.stringify(selectedCompany));\n      // Keep legacy ID for compatibility\n      localStorage.setItem('selectedCompanyId', selectedCompany.id);\r\n    }\r\n    // We strictly DO NOT clear localStorage here if selectedCompany is null,\r\n    // to prevent accidental data loss during state transitions or mounting.\n    // Clearing storage is handled explicitly by the signOut function in AuthContext.\n  }, [selectedCompany]);\n\n  // Auto-select the company the user is registered to (default) once per user session\n  useEffect(() => {\n    const userId = profile?.id ?? null;\n    const targetCompanyId = profile?.company_id ?? null;\n\n    // Reset guard when user changes\n    if (autoSelectLock.current.userId !== userId) {\n      autoSelectLock.current = { userId, applied: false };\n    }\n\n    if (!userId || !targetCompanyId) return;\n\n    const alreadySelected = selectedCompany?.id === targetCompanyId;\n    if (alreadySelected || autoSelectLock.current.applied) return;\n\n    const fetchAndSelect = async () => {\n      try {\n        const { data, error } = await supabase\n          .from('companies')\n          .select('id, name, is_active')\n          .eq('id', targetCompanyId)\n          .maybeSingle();\n\n        if (error) throw error;\n\n        if (data) {\n          setSelectedCompany({\n            id: data.id,\n            name: data.name,\n            is_active: data.is_active,\n          });\n        }\n      } catch (err) {\n        console.error('Error auto-selecting company for user:', err);\n      } finally {\n        autoSelectLock.current.applied = true;\n      }\n    };\n\n    fetchAndSelect();\n  }, [profile?.id, profile?.company_id, selectedCompany]);\n\n  return (\n    <CompanyContext.Provider value={{\n      selectedCompany,\n      selectedCompanyId: selectedCompany?.id || null,\n      setSelectedCompany\n    }}>\r\n      {children}\r\n    </CompanyContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useCompany() {\r\n  const context = useContext(CompanyContext);\r\n  if (context === undefined) {\r\n    throw new Error('useCompany must be used within a CompanyProvider');\r\n  }\r\n  return context;\r\n}\n","usedDeprecatedRules":[]},{"filePath":"F:\\WendelWenKey\\src\\pages\\KRCheckins.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadUserProfile'. Either include it or remove the dependency array.","line":139,"column":6,"nodeType":"ArrayExpression","endLine":139,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [user, roleLoading, loadUserProfile]","fix":{"range":[4871,4890],"text":"[user, roleLoading, loadUserProfile]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadCompanies'. Either include it or remove the dependency array.","line":192,"column":6,"nodeType":"ArrayExpression","endLine":192,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [loadCompanies, userProfile]","fix":{"range":[6171,6184],"text":"[loadCompanies, userProfile]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadQuarters'. Either include it or remove the dependency array.","line":203,"column":6,"nodeType":"ArrayExpression","endLine":203,"endColumn":55,"suggestions":[{"desc":"Update the dependencies array to be: [selectedCompanyId, filterCompanyId, userProfile, loadQuarters]","fix":{"range":[6484,6533],"text":"[selectedCompanyId, filterCompanyId, userProfile, loadQuarters]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadUsers' and 'role'. Either include them or remove the dependency array.","line":215,"column":6,"nodeType":"ArrayExpression","endLine":215,"endColumn":36,"suggestions":[{"desc":"Update the dependencies array to be: [filterCompanyId, loadUsers, role, userProfile]","fix":{"range":[6848,6878],"text":"[filterCompanyId, loadUsers, role, userProfile]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadObjectivesAndKRs' and 'loadQuarterCheckins'. Either include them or remove the dependency array.","line":222,"column":6,"nodeType":"ArrayExpression","endLine":222,"endColumn":68,"suggestions":[{"desc":"Update the dependencies array to be: [selectedQuarter, filterCompanyId, filterOwnerId, userProfile, loadQuarterCheckins, loadObjectivesAndKRs]","fix":{"range":[7021,7083],"text":"[selectedQuarter, filterCompanyId, filterOwnerId, userProfile, loadQuarterCheckins, loadObjectivesAndKRs]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadCheckinResults'. Either include it or remove the dependency array.","line":228,"column":6,"nodeType":"ArrayExpression","endLine":228,"endColumn":35,"suggestions":[{"desc":"Update the dependencies array to be: [keyResults, loadCheckinResults, quarterCheckins]","fix":{"range":[7215,7244],"text":"[keyResults, loadCheckinResults, quarterCheckins]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":446,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":446,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13294,13297],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13294,13297],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":787,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":787,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25348,25351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25348,25351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1003,"column":89,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1003,"endColumn":92,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33138,33141],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33138,33141],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'getCheckinTime'. Either include it or remove the dependency array.","line":1217,"column":6,"nodeType":"ArrayExpression","endLine":1217,"endColumn":36,"suggestions":[{"desc":"Update the dependencies array to be: [quarterCheckins, currentDate, getCheckinTime]","fix":{"range":[40112,40142],"text":"[quarterCheckins, currentDate, getCheckinTime]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'getCheckinTime'. Either include it or remove the dependency array.","line":1234,"column":6,"nodeType":"ArrayExpression","endLine":1234,"endColumn":61,"suggestions":[{"desc":"Update the dependencies array to be: [quarterCheckins, selectedCheckinDate, activeCheckinId, getCheckinTime]","fix":{"range":[40768,40823],"text":"[quarterCheckins, selectedCheckinDate, activeCheckinId, getCheckinTime]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'getCheckinTime'. Either include it or remove the dependency array.","line":1370,"column":6,"nodeType":"ArrayExpression","endLine":1370,"endColumn":66,"suggestions":[{"desc":"Update the dependencies array to be: [quarterCheckins, checkinOverallAverages, currentDate, role, getCheckinTime]","fix":{"range":[45125,45185],"text":"[quarterCheckins, checkinOverallAverages, currentDate, role, getCheckinTime]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1588,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1588,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[57073,57076],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[57073,57076],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1788,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1788,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[67553,67556],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[67553,67556],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo, useCallback } from 'react';\r\nimport { Layout } from '@/components/Layout';\r\nimport { Card, CardContent } from '@/components/ui/card';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\r\n\r\nimport { Progress } from '@/components/ui/progress';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useCompany } from '@/contexts/CompanyContext';\r\nimport { useAuth } from '@/contexts/AuthContext';\r\nimport { useUserRole } from '@/hooks/useUserRole';\r\nimport { toTitleCase } from '@/lib/utils';\r\nimport { calculateDeadlineProgress } from '@/lib/deadlineProgress';\r\n\r\ninterface Quarter {\r\n  id: string;\r\n  name: string;\r\n  start_date: string;\r\n  end_date: string;\r\n}\r\n\r\ninterface QuarterCheckin {\r\n  id: string;\r\n  quarter_id: string;\r\n  checkin_date: string;\r\n  name?: string;\r\n  is_active?: boolean;\r\n  result_percent?: number | null;\r\n}\r\n\r\ninterface Objective {\r\n  id: string;\r\n  title: string;\r\n  quarter_id: string;\r\n}\r\n\r\ninterface KeyResult {\r\n  id: string;\r\n  objective_id: string;\r\n  company_id: string;\r\n  user_id: string | null;\r\n  code: string | null;\r\n  title: string;\r\n  type: string | null;\r\n  direction: string | null;\r\n  unit: string | null;\r\n  baseline: number | null;\r\n  floor_value: number | null;\r\n  target: number | null;\r\n  weight: number;\r\n}\r\n\r\ninterface CheckinResult {\r\n  id?: string;\r\n  key_result_id: string;\r\n  checkin_id: string;\r\n  user_id: string | null;\r\n  valor_realizado: number | null;\r\n  percentual_atingido: number | null;\r\n  meta_checkin: number | null;\r\n  minimo_orcamento: number | null;\r\n  note?: string | null;\r\n}\r\n\r\ninterface Company {\r\n  id: string;\r\n  name: string;\r\n}\r\n\r\ninterface User {\r\n  id: string;\r\n  full_name: string;\r\n  company_id: string | null;\r\n}\r\n\r\ninterface UserProfile {\r\n  id: string;\r\n  company_id: string | null;\r\n}\r\n\r\nexport default function KRCheckins() {\r\n  const { toast } = useToast();\r\n  const { selectedCompanyId, selectedCompany } = useCompany();\r\n  const { user } = useAuth();\r\n  const { role, loading: roleLoading } = useUserRole();\r\n  const canEditAnyCheckin = role === 'admin' || role === 'manager';\r\n  const [userProfile, setUserProfile] = useState<UserProfile | null>(null);\r\n  const [quarters, setQuarters] = useState<Quarter[]>([]);\r\n  const [selectedQuarter, setSelectedQuarter] = useState<string>('');\r\n  const [quarterCheckins, setQuarterCheckins] = useState<QuarterCheckin[]>([]);\r\n  const [objectives, setObjectives] = useState<Objective[]>([]);\r\n  const [keyResults, setKeyResults] = useState<KeyResult[]>([]);\r\n  const [checkinResults, setCheckinResults] = useState<Record<string, CheckinResult>>({});\r\n  const [editingData, setEditingData] = useState<Record<string, { meta: string; minimo: string; realizado: string }>>({});\r\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\r\n  const [currentKR, setCurrentKR] = useState<KeyResult | null>(null);\r\n  const [currentCheckin, setCurrentCheckin] = useState<QuarterCheckin | null>(null);\r\n  const [formData, setFormData] = useState({ meta: '', minimo: '', realizado: '', observacoes: '' });\r\n\r\n  // Novos filtros\r\n  const [companies, setCompanies] = useState<Company[]>([]);\r\n  const [filterCompanyId, setFilterCompanyId] = useState<string>('all');\r\n  const [users, setUsers] = useState<User[]>([]);\r\n  const [filterOwnerId, setFilterOwnerId] = useState<string>('all');\r\n  const [selectedCheckinDate, setSelectedCheckinDate] = useState<string | null>(null);\r\n  const [currentResult, setCurrentResult] = useState<number>(0);\r\n  const [currentDate, setCurrentDate] = useState<Date>(new Date());\r\n\r\n  useEffect(() => {\r\n    if (roleLoading || role !== 'admin') return;\r\n\r\n    if (selectedCompanyId && filterCompanyId !== selectedCompanyId) {\r\n      setFilterCompanyId(selectedCompanyId);\r\n      setFilterOwnerId('all');\r\n    } else if (!selectedCompanyId && filterCompanyId !== 'all') {\r\n      setFilterCompanyId('all');\r\n      setFilterOwnerId('all');\r\n    }\r\n  }, [selectedCompanyId, role, roleLoading, filterCompanyId]);\r\n\r\n  // Sempre alinhar filtro ├á empresa escolhida na sidebar\r\n  useEffect(() => {\r\n    if (selectedCompanyId && filterCompanyId !== selectedCompanyId) {\r\n      setFilterCompanyId(selectedCompanyId);\r\n      setFilterOwnerId('all');\r\n    }\r\n  }, [selectedCompanyId, filterCompanyId]);\r\n\r\n  // Carregar perfil do usu├írio\r\n  useEffect(() => {\r\n    if (user && !roleLoading) {\r\n      loadUserProfile();\r\n    }\r\n  }, [user, roleLoading]);\r\n\r\n\r\n\r\n  // Resetar data selecionada quando quarter mudar\r\n  useEffect(() => {\r\n    setSelectedCheckinDate(null);\r\n  }, [selectedQuarter]);\r\n\r\n  useEffect(() => {\r\n    const interval = setInterval(() => setCurrentDate(new Date()), 60000);\r\n    return () => clearInterval(interval);\r\n  }, []);\r\n\r\n  const loadUserProfile = async () => {\r\n    if (!user) return;\r\n\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .select('id, company_id')\r\n      .eq('id', user.id)\r\n      .single();\r\n\r\n    if (error) {\r\n      toast({\r\n        title: 'Erro ao carregar perfil',\r\n        description: error.message,\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    setUserProfile(data);\r\n\r\n    // Aplicar filtros autom├íticos baseado no perfil\r\n    if (role === 'user') {\r\n      // User: fixar na empresa e no pr├│prio usu├írio\r\n      if (data.company_id) {\r\n        setFilterCompanyId(data.company_id);\r\n      }\r\n      setFilterOwnerId(user.id);\r\n    } else if (role === 'manager') {\r\n      // Manager: fixar na empresa dele\r\n      if (data.company_id) {\r\n        setFilterCompanyId(data.company_id);\r\n      }\r\n    }\r\n    // Admin: n├úo aplica filtro autom├ítico\r\n  };\r\n  useEffect(() => {\r\n    if (userProfile) {\r\n      loadCompanies();\r\n    }\r\n  }, [userProfile]);\r\n\r\n  useEffect(() => {\r\n    const companyIdToLoad =\r\n      (filterCompanyId && filterCompanyId !== 'all')\r\n        ? filterCompanyId\r\n        : (userProfile?.company_id ? userProfile.company_id : selectedCompanyId);\r\n\r\n    if (companyIdToLoad) {\r\n      loadQuarters(companyIdToLoad);\r\n    }\r\n  }, [selectedCompanyId, filterCompanyId, userProfile]);\r\n\r\n  useEffect(() => {\r\n    if (filterCompanyId && filterCompanyId !== 'all') {\r\n      loadUsers();\r\n    } else {\r\n      setUsers([]);\r\n      // N├úo resetar filterOwnerId se for 'user', pois ele deve manter fixo no pr├│prio ID\r\n      if (role !== 'user') {\r\n        setFilterOwnerId('all');\r\n      }\r\n    }\r\n  }, [filterCompanyId, userProfile]);\r\n\r\n  useEffect(() => {\r\n    if (selectedQuarter && userProfile) {\r\n      loadQuarterCheckins();\r\n      loadObjectivesAndKRs();\r\n    }\r\n  }, [selectedQuarter, filterCompanyId, filterOwnerId, userProfile]);\r\n\r\n  useEffect(() => {\r\n    if (keyResults.length > 0 && quarterCheckins.length > 0) {\r\n      loadCheckinResults();\r\n    }\r\n  }, [keyResults, quarterCheckins]);\r\n\r\n  const loadCompanies = async () => {\r\n    // Admin v├¬ todas, manager/user v├¬ apenas a sua\r\n    let query = supabase\r\n      .from('companies')\r\n      .select('id, name')\r\n      .eq('is_active', true);\r\n\r\n    if (role !== 'admin') {\r\n      // Manager e User: filtrar pela empresa do perfil\r\n      if (userProfile?.company_id) {\r\n        query = query.eq('id', userProfile.company_id);\r\n      }\r\n    }\r\n\r\n    const { data, error } = await query.order('name');\r\n\r\n    if (error) {\r\n      toast({\r\n        title: 'Erro ao carregar empresas',\r\n        description: error.message,\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    setCompanies(data || []);\r\n  };\r\n\r\n  const loadUsers = async () => {\r\n    if (!filterCompanyId) return;\r\n\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .select('id, full_name, company_id')\r\n      .eq('company_id', filterCompanyId)\r\n      .eq('is_active', true)\r\n      .order('full_name');\r\n\r\n    if (error) {\r\n      toast({\r\n        title: 'Erro ao carregar usu├írios',\r\n        description: error.message,\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    setUsers(data || []);\r\n  };\r\n\r\n  const loadQuarters = async (companyId: string) => {\r\n    const { data, error } = await supabase\r\n      .from('quarters')\r\n      .select('*')\r\n      .eq('company_id', companyId)\r\n      .eq('is_active', true)\r\n      .order('start_date', { ascending: false });\r\n\r\n    if (error) {\r\n      toast({\r\n        title: 'Erro ao carregar trimestres',\r\n        description: error.message,\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    setQuarters(data || []);\r\n    if (data && data.length > 0) {\r\n      setSelectedQuarter(data[0].id);\r\n    } else {\r\n      setSelectedQuarter('');\r\n    }\r\n  };\r\n\r\n  const loadQuarterCheckins = async () => {\r\n    if (!selectedQuarter) return;\r\n\r\n    const { data, error } = await supabase\r\n      .from('checkins')\r\n      .select('*')\r\n      .eq('quarter_id', selectedQuarter)\r\n      .order('checkin_date', { ascending: true });\r\n\r\n    if (error) {\r\n      toast({\r\n        title: 'Erro ao carregar checkins',\r\n        description: error.message,\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    setQuarterCheckins(data || []);\r\n\r\n    // Se n´┐¢´┐¢o houver KRs carregados, limpamos os resultados mas mantemos os check-ins carregados\r\n    if (keyResults.length === 0) {\r\n      setCheckinResults({});\r\n    }\r\n  };\r\n\r\n  const loadObjectivesAndKRs = async () => {\r\n    if (!selectedQuarter || !user) return;\r\n\r\n    let objectivesQuery = supabase\r\n      .from('objectives')\r\n      .select('id, title, quarter_id')\r\n      .eq('quarter_id', selectedQuarter)\r\n      .eq('archived', false);\r\n\r\n    // Aplica filtro de usu├írio conforme sele├º├úo/permiss├úo\r\n    const selectedUserId = role === 'user'\r\n      ? user.id\r\n      : (filterOwnerId && filterOwnerId !== 'all' ? filterOwnerId : null);\r\n    if (selectedUserId) {\r\n      objectivesQuery = objectivesQuery.eq('user_id', selectedUserId);\r\n    }\r\n\r\n    // Aplicar filtro de empresa se selecionado\r\n    if (filterCompanyId && filterCompanyId !== 'all') {\r\n      objectivesQuery = objectivesQuery.eq('company_id', filterCompanyId);\r\n    } else if (selectedCompanyId) {\r\n      objectivesQuery = objectivesQuery.eq('company_id', selectedCompanyId);\r\n    }\r\n\r\n    const { data: objData, error: objError } = await objectivesQuery;\r\n\r\n    if (objError) {\r\n      toast({\r\n        title: 'Erro ao carregar objetivos',\r\n        description: objError.message,\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    setObjectives(objData || []);\r\n\r\n    if (objData && objData.length > 0) {\r\n      const objectiveIds = objData.map(o => o.id);\r\n\r\n      const { data: krData, error: krError } = await supabase\r\n        .from('key_results')\r\n        .select('*')\r\n        .in('objective_id', objectiveIds);\r\n\r\n      if (krError) {\r\n        toast({\r\n          title: 'Erro ao carregar key results',\r\n          description: krError.message,\r\n          variant: 'destructive',\r\n        });\r\n        return;\r\n      }\r\n\r\n      setKeyResults(krData || []);\r\n    } else {\r\n      setKeyResults([]);\r\n    }\r\n  };\r\n\r\n  const getProgressColor = (percentage: number): string => {\r\n    // Verde apenas quando atingimento for 100% (ou acima, j├í clamped)\r\n    if (percentage >= 100) return '#00CC00';\r\n    if (percentage >= 70) return '#FFCC00'; // Amarelo para alto mas n├úo completo\r\n    if (percentage >= 40) return '#FF6600'; // Laranja\r\n    return '#FF0000'; // Vermelho para baixo\r\n  };\r\n\r\n  const loadCheckinResults = async () => {\r\n    if (!selectedQuarter) return;\r\n\r\n    // Determinar o filtro de usu├írio selecionado (para filtrar pelo dono do KR)\r\n    let selectedUserId: string | null = null;\r\n    if (role === 'user') {\r\n      selectedUserId = user?.id || null;\r\n    } else if (role === 'manager' || role === 'admin') {\r\n      if (filterOwnerId && filterOwnerId !== 'all') {\r\n        selectedUserId = filterOwnerId;\r\n      }\r\n    }\r\n\r\n    const checkinIds = quarterCheckins.map((c) => c.id);\r\n    if (checkinIds.length === 0) {\r\n      setCheckinResults({});\r\n      return;\r\n    }\r\n\r\n    const ownerMap = keyResults.reduce<Record<string, string | null>>((acc, kr) => {\r\n      acc[kr.id] = kr.user_id ?? null;\r\n      return acc;\r\n    }, {});\r\n\r\n    // Buscar resultados do check-in do quarter selecionado\r\n    // Se um usu├írio for selecionado, filtramos pelo DONO do KR (key_results.user_id)\r\n    let query = supabase\r\n      .from('checkin_results')\r\n      .select('*, key_results!inner(user_id)')\r\n      .in('checkin_id', checkinIds);\r\n\r\n    if (selectedUserId) {\r\n      query = query.eq('key_results.user_id', selectedUserId);\r\n    }\r\n\r\n    const { data, error } = await query;\r\n\r\n    if (error) {\r\n      toast({\r\n        title: 'Erro ao carregar valores',\r\n        description: error.message,\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    const resultsMap: Record<string, CheckinResult> = {};\r\n    data?.forEach((result: any) => {\r\n      const ownerId =\r\n        ownerMap[result.key_result_id] ?? result.key_results?.user_id ?? null;\r\n\r\n      const isManagerOrAdmin = role === 'manager' || role === 'admin';\r\n\r\n      if (ownerId && result.user_id && ownerId !== result.user_id && !isManagerOrAdmin) {\r\n        return;\r\n      }\r\n\r\n      if (role === 'user' && ownerId && ownerId !== user?.id) {\r\n        return;\r\n      }\r\n\r\n      const key = `${result.key_result_id}-${result.checkin_id}`;\r\n      resultsMap[key] = {\r\n        id: result.id,\r\n        key_result_id: result.key_result_id,\r\n        checkin_id: result.checkin_id,\r\n        user_id: result.user_id ?? null,\r\n        valor_realizado: result.valor_realizado,\r\n        percentual_atingido: result.percentual_atingido,\r\n        meta_checkin: result.meta_checkin,\r\n        minimo_orcamento: result.minimo_orcamento,\r\n        note: result.note ?? null,\r\n      };\r\n    });\r\n\r\n    setCheckinResults(resultsMap);\r\n  };\r\n\r\n  const formatInputValue = (value: string, type: string | null) => {\r\n    if (!value) return '';\r\n\r\n    if (type === 'date' || type === 'data') {\r\n      if (value.includes('-')) return value;\r\n      const timestamp = parseFloat(value);\r\n      if (isNaN(timestamp)) return value;\r\n      const d = new Date(timestamp);\r\n      const year = d.getFullYear();\r\n      const month = String(d.getMonth() + 1).padStart(2, '0');\r\n      const day = String(d.getDate()).padStart(2, '0');\r\n      return `${year}-${month}-${day}`;\r\n    }\r\n\r\n    const numValue = parseFloat(parseInputValue(value));\r\n    if (isNaN(numValue)) return value;\r\n\r\n    switch (type) {\r\n      case 'percentual':\r\n      case 'percentage':\r\n        return `${numValue}%`;\r\n      case 'moeda':\r\n      case 'currency':\r\n        return numValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });\r\n      default:\r\n        return numValue.toLocaleString('pt-BR');\r\n    }\r\n  };\r\n\r\n  const parseInputValue = (value: string) => {\r\n    if (!value) return '';\r\n\r\n    // Remove currency/percent symbols and spaces (including NBSP/thin space)\r\n    let v = value.replace(/[R$%]/g, '').replace(/[\\s\\u00A0\\u202F]/g, '');\r\n\r\n    // If value has both '.' and ',', assume Brazilian format: '.' thousands and ',' decimal\r\n    if (v.includes(',') && v.includes('.')) {\r\n      v = v.replace(/\\./g, '').replace(',', '.');\r\n    } else if (v.includes(',') && !v.includes('.')) {\r\n      // Only comma -> decimal separator\r\n      v = v.replace(',', '.');\r\n    } else if (v.includes('.')) {\r\n      // Only dots present. If multiple dots, keep the last as decimal and remove the rest (thousands)\r\n      v = v.replace(/\\.(?=.*\\.)/g, '');\r\n    }\r\n\r\n    return v;\r\n  };\r\n\r\n  const parseDateInputToMs = (val: string): number | null => {\r\n    if (!val) return null;\r\n    const parts = val.split('-').map((p) => Number(p));\r\n    if (parts.length !== 3 || parts.some((n) => Number.isNaN(n))) return null;\r\n    const d = new Date(parts[0], parts[1] - 1, parts[2]);\r\n    d.setHours(0, 0, 0, 0);\r\n    return d.getTime();\r\n  };\r\n\r\n  const parseValueForType = (raw: string, type: string | null): number | null => {\r\n    if (!raw) return null;\r\n    if (type === 'date' || type === 'data') {\r\n      return parseDateInputToMs(raw);\r\n    }\r\n    const num = parseFloat(parseInputValue(raw));\r\n    return Number.isNaN(num) ? null : num;\r\n  };\r\n\r\n  // Live mask for Brazilian Real currency (e.g., \"R$ 10.000.000,00\")\r\n  const formatCurrencyInputLive = (raw: string) => {\r\n    if (!raw) return '';\r\n    const digits = raw.replace(/\\D/g, '');\r\n    if (!digits) return '';\r\n\r\n    // Separate integer and decimal parts (2 decimal digits) and remove leading zeros from the integer part\r\n    let intPartRaw = digits.length > 2 ? digits.slice(0, -2) : '0';\r\n    const decPart = digits.slice(-2).padStart(2, '0');\r\n    intPartRaw = intPartRaw.replace(/^0+(?=\\d)/, ''); // keep single 0, remove extra leading zeros\r\n\r\n    const intFormatted = (intPartRaw || '0').replace(/\\B(?=(\\d{3})+(?!\\d))/g, '.');\r\n    return `R$ ${intFormatted},${decPart}`;\r\n  };\r\n\r\n  // Live mask for Percentage (e.g., \"85%\")\r\n  const formatPercentageInputLive = (raw: string) => {\r\n    if (!raw) return '';\r\n    const digits = raw.replace(/[^\\d,.-]/g, '');\r\n    if (!digits) return '';\r\n    return `${digits}%`;\r\n  };\r\n\r\n  // Live mask for Number with Brazilian formatting (e.g., \"10.000\")\r\n  const formatNumberInputLive = (raw: string) => {\r\n    if (!raw) return '';\r\n    const cleaned = raw.replace(/[^\\d]/g, '');\r\n    if (!cleaned) return '';\r\n    const formatted = cleaned.replace(/\\B(?=(\\d{3})+(?!\\d))/g, '.');\r\n    return formatted;\r\n  };\r\n  const openDialog = async (kr: KeyResult, checkin: QuarterCheckin) => {\r\n    setCurrentKR(kr);\r\n    setCurrentCheckin(checkin);\r\n    const key = `${kr.id}-${checkin.id}`;\r\n    const existing = checkinResults[key];\r\n\r\n    // Fetch the note from the database if it exists\r\n    let note = existing?.note || '';\r\n    if (!note && existing?.id) {\r\n      const { data } = await supabase\r\n        .from('checkin_results')\r\n        .select('note')\r\n        .eq('id', existing.id)\r\n        .single();\r\n      note = data?.note || '';\r\n    }\r\n\r\n    setFormData({\r\n      meta: existing?.meta_checkin != null ? formatInputValue(existing.meta_checkin.toString(), kr.type) : '',\r\n      minimo: existing?.minimo_orcamento != null ? formatInputValue(existing.minimo_orcamento.toString(), kr.type) : '',\r\n      realizado: existing?.valor_realizado != null ? formatInputValue(existing.valor_realizado.toString(), kr.type) : '',\r\n      observacoes: note,\r\n    });\r\n    setIsDialogOpen(true);\r\n  };\r\n\r\n  const closeDialog = () => {\r\n    setIsDialogOpen(false);\r\n    setCurrentKR(null);\r\n    setCurrentCheckin(null);\r\n    setFormData({ meta: '', minimo: '', realizado: '', observacoes: '' });\r\n  };\r\n\r\n  const handleSaveCheckin = async (e?: React.MouseEvent) => {\r\n    if (e) {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n    }\r\n\r\n    console.log('handleSaveCheckin iniciado');\r\n    if (!currentKR || !currentCheckin) {\r\n      console.log('currentKR ou currentCheckin n├úo definidos', { currentKR, currentCheckin });\r\n      return;\r\n    }\r\n\r\n    if (!selectedCompanyId) {\r\n      console.log('selectedCompanyId n├úo definido');\r\n      toast({\r\n        title: 'Erro',\r\n        description: 'Empresa n├úo selecionada',\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    let meta: number;\r\n    let minimo: number;\r\n    let realizado: number;\r\n\r\n    if (currentKR.type === 'date' || currentKR.type === 'data') {\r\n      const getTime = (val: string) => {\r\n        if (!val) return NaN;\r\n        // Input date returns YYYY-MM-DD. Parse as local date noon to avoid timezone issues or just use Y,M,D\r\n        const parts = val.split('-');\r\n        if (parts.length !== 3) return NaN;\r\n        // Note: using local time (00:00:00)\r\n        return new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2])).getTime();\r\n      };\r\n\r\n      meta = getTime(formData.meta);\r\n      minimo = getTime(formData.minimo);\r\n      realizado = getTime(formData.realizado);\r\n    } else {\r\n      meta = parseFloat(parseInputValue(formData.meta));\r\n      minimo = parseFloat(parseInputValue(formData.minimo));\r\n      realizado = parseFloat(parseInputValue(formData.realizado));\r\n    }\r\n\r\n    console.log('Valores parseados:', { meta, minimo, realizado });\r\n\r\n    if (isNaN(meta) || isNaN(minimo)) {\r\n      toast({\r\n        title: 'Erro',\r\n        description: 'Meta e M├¡nimo Or├ºamento s├úo obrigat├│rios',\r\n        variant: 'destructive',\r\n      });\r\n      return;\r\n    }\r\n\r\n    const kr = currentKR;\r\n\r\n    // Calcular percentual de atingimento:\r\n    // - aumento (maior ´┐¢ melhor): realizado / meta (limitado a 100%)\r\n    // - redu´┐¢´┐¢o (menor ´┐¢ melhor): meta / realizado (limitado a 100%; se realizado <= meta, conta 100%)\r\n    // Atingimento Visual (Realizado / Meta)\r\n    const simpleAttainment = calculateSimpleAttainment(\r\n      isNaN(realizado) ? null : realizado,\r\n      isNaN(meta) ? null : meta,\r\n      kr.direction,\r\n      kr.type\r\n    );\r\n\r\n    // Calcular percentual de progresso do KR (com Piso):\r\n    const percentualAtingido = calculateKR(\r\n      isNaN(realizado) ? null : realizado,\r\n      isNaN(minimo) ? null : minimo,\r\n      isNaN(meta) ? null : meta,\r\n      kr.direction,\r\n      kr.type\r\n    );\r\n\r\n    // O checkin_results.percentual_atingido vai armazenar o Atingimento Visual (Realizado / Meta)\r\n    // Se for data, usamos o c├ílculo de KR como fallback\r\n    const visualAttainment = (kr.type === 'date' || kr.type === 'data') ? percentualAtingido : simpleAttainment;\r\n    const roundedVisualAttainment = visualAttainment === null ? null : Number(visualAttainment.toFixed(2));\r\n\r\n    // O progresso real do KR (com Piso) que sincroniza com rankings e m├®dia\r\n    const roundedKRProgress = percentualAtingido === null ? null : Number(percentualAtingido.toFixed(2));\r\n\r\n    const key = `${currentKR.id}-${currentCheckin.id}`;\r\n    const existingResult = checkinResults[key];\r\n\r\n    try {\r\n      if (existingResult?.id) {\r\n        // Atualizar\r\n        if (!user?.id) {\r\n          toast({\r\n            title: 'Erro',\r\n            description: 'Usu├írio n├úo autenticado',\r\n            variant: 'destructive',\r\n          });\r\n          throw new Error('Usu├írio n├úo autenticado');\r\n        }\r\n\r\n        console.log('Atualizando registro existente:', existingResult.id);\r\n        const { error: updateError, data: updatedRows } = await supabase\r\n          .from('checkin_results')\r\n          .update({\r\n            meta_checkin: meta,\r\n            minimo_orcamento: minimo,\r\n            valor_realizado: isNaN(realizado) ? null : realizado,\r\n            percentual_atingido: roundedVisualAttainment,\r\n            note: formData.observacoes || null,\r\n            updated_at: new Date().toISOString(),\r\n          })\r\n          .eq('id', existingResult.id)\r\n          .select();\r\n\r\n        if (updateError) {\r\n          console.error('Erro ao atualizar:', updateError);\r\n          throw updateError;\r\n        }\r\n        if (!updatedRows || updatedRows.length === 0) {\r\n          console.warn('Nenhuma linha atualizada (poss├¡vel bloqueio por RLS)');\r\n          throw new Error(\r\n            canEditAnyCheckin\r\n              ? 'N├úo foi poss├¡vel atualizar este check-in. Verifique se ele ainda existe.'\r\n              : 'Voc├¬ n├úo tem permiss├úo para atualizar este check-in'\r\n          );\r\n        }\r\n        console.log('Atualiza├º├úo bem-sucedida');\r\n      } else {\r\n        // Criar\r\n        if (!user?.id) {\r\n          toast({\r\n            title: \"Erro\",\r\n            description: \"Usu├írio n├úo autenticado\",\r\n            variant: \"destructive\",\r\n          });\r\n          throw new Error(\"Usu├írio n├úo autenticado\");\r\n        }\r\n\r\n        const responsibleUserId = currentKR.user_id || user.id;\r\n        if (!responsibleUserId) {\r\n          throw new Error('N├úo foi poss├¡vel identificar o respons├ível pelo check-in.');\r\n        }\r\n\r\n        const insertData = {\r\n          key_result_id: currentKR.id,\r\n          checkin_id: currentCheckin.id,\r\n          company_id: currentKR.company_id || selectedCompanyId,\r\n          user_id: responsibleUserId,\r\n          meta_checkin: meta,\r\n          minimo_orcamento: minimo,\r\n          valor_realizado: isNaN(realizado) ? null : realizado,\r\n          percentual_atingido: roundedVisualAttainment,\r\n          note: formData.observacoes || null,\r\n        };\r\n        console.log('Criando novo registro:', insertData);\r\n\r\n        const { error, data } = await supabase\r\n          .from('checkin_results')\r\n          .insert(insertData)\r\n          .select();\r\n\r\n        if (error) {\r\n          console.error('Erro ao inserir:', error);\r\n          throw error;\r\n        }\r\n        console.log('Inser├º├úo bem-sucedida:', data);\r\n      }\r\n\r\n      await updateStoredProgress(kr, roundedKRProgress);\r\n      // Recarregar os dados para refletir as mudan├ºas\r\n      await loadCheckinResults();\r\n\r\n      toast({\r\n        title: 'Sucesso',\r\n        description: 'Dados salvos com sucesso',\r\n      });\r\n\r\n      closeDialog();\r\n    } catch (error: any) {\r\n      console.error('Erro no catch:', error);\r\n      toast({\r\n        title: 'Erro ao salvar',\r\n        description: error.message || 'Erro desconhecido',\r\n        variant: 'destructive',\r\n      });\r\n    }\r\n  };\r\n\r\n  const formatDate = (dateString: string) => {\r\n    const [year, month, day] = dateString.split('-').map(Number);\r\n    const date = new Date(year, month - 1, day);\r\n    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });\r\n  };\r\n\r\n  const formatValue = (value: number | null, type: string | null, unit: string | null) => {\r\n    if (value === null || value === undefined) return '--';\r\n\r\n    const numValue = typeof value === 'string' ? parseFloat(value) : value;\r\n    if (isNaN(numValue)) return '--';\r\n\r\n    switch (type) {\r\n      case 'percentual':\r\n      case 'percentage':\r\n        return `${numValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%`;\r\n      case 'moeda':\r\n      case 'currency':\r\n        return numValue.toLocaleString('pt-BR', {\r\n          style: 'currency',\r\n          currency: 'BRL',\r\n          minimumFractionDigits: 2,\r\n          maximumFractionDigits: 2\r\n        });\r\n      case 'date':\r\n      case 'data':\r\n        return new Date(numValue).toLocaleDateString('pt-BR');\r\n      default:\r\n        return `${numValue.toLocaleString('pt-BR')} ${unit || ''}`;\r\n    }\r\n  };\r\n\r\n  const translateType = (type: string | null) => {\r\n    switch (type) {\r\n      case 'currency':\r\n      case 'moeda':\r\n        return 'moeda';\r\n      case 'percentual':\r\n        return 'percentual';\r\n      case 'numero':\r\n        return 'n├║mero';\r\n      case 'date':\r\n      case 'data':\r\n        return 'data';\r\n      default:\r\n        return type || '--';\r\n    }\r\n  };\r\n\r\n  const translateDirection = (direction: string | null) => {\r\n    switch (direction) {\r\n      case 'increase':\r\n        return 'crescente';\r\n      case 'decrease':\r\n        return 'decrescente';\r\n      case 'greater_than':\r\n        return 'maior que';\r\n      case 'less_than':\r\n        return 'menor que';\r\n      default:\r\n        return direction || '--';\r\n    }\r\n  };\r\n\r\n  const calculateSimpleAttainment = (\r\n    realized: number | null,\r\n    target: number | null,\r\n    direction: string | null,\r\n    type?: string | null\r\n  ): number | null => {\r\n    if (target === null || target === undefined || Number.isNaN(Number(target)) || Number(target) === 0) return null;\r\n    const safeRealized = (realized === null || realized === undefined || Number.isNaN(Number(realized))) ? null : Number(realized);\r\n    if (safeRealized === null) return null;\r\n\r\n    const safeTarget = Number(target);\r\n\r\n    // Date/Data logic remains range-based usually, but the user said \"realizado / meta\"\r\n    // For dates, it's not a simple division. I'll keep calculateKR for dates unless asked otherwise,\r\n    // as \"realizado/meta\" doesn't translate well to timestamps.\r\n    if (type === 'date' || type === 'data') {\r\n      return null; // Fallback to calculateKR or skip\r\n    }\r\n\r\n    if (!direction || direction === 'increase' || direction === 'maior-├®-melhor') {\r\n      return (safeRealized / safeTarget) * 100;\r\n    } else {\r\n      // Decrease (Menor ├® melhor): meta / realizado capped at 100? \r\n      // User said \"realizado / meta\", but for decrease that would mean lower is worse.\r\n      // I'll use target/realized for decrease simple attainment.\r\n      if (safeRealized <= safeTarget) return 100;\r\n      return (safeTarget / safeRealized) * 100;\r\n    }\r\n  };\r\n\r\n  const calculateKR = (\r\n    realized: number | null,\r\n    min: number | null,\r\n    target: number | null,\r\n    direction: string | null,\r\n    type?: string | null\r\n  ): number | null => {\r\n    // Basic safety\r\n    if (target === null || target === undefined || Number.isNaN(Number(target))) return null;\r\n\r\n    const safeTarget = Number(target);\r\n    const safeRealized = (realized === null || realized === undefined || Number.isNaN(Number(realized))) ? null : Number(realized);\r\n    const safeMin = (min !== null && min !== undefined) ? Number(min) : null;\r\n\r\n    // L├│gica espec├¡fica para DATAS\r\n    if (type === 'date' || type === 'data') {\r\n      if (safeRealized === null) return null;\r\n      const limit = safeMin !== null ? safeMin : safeTarget;\r\n      return calculateDeadlineProgress(safeTarget, limit, safeRealized);\r\n    }\r\n\r\n    if (safeRealized === null) return null;\r\n\r\n    // Logic for \"Increase\" / \"Maior ├® melhor\" (Default)\r\n    if (!direction || direction === 'increase' || direction === 'maior-├®-melhor') {\r\n\r\n      // If Minimum Budget (Piso) is defined\r\n      if (safeMin !== null) {\r\n        // Realized >= Target -> 100%\r\n        if (safeRealized >= safeTarget) return 100;\r\n\r\n        // Realized < Min -> 0%\r\n        if (safeRealized < safeMin) return 0;\r\n\r\n        // Formula: ((Realized - Min) / (Target - Min)) * 100\r\n        const denominator = safeTarget - safeMin;\r\n        if (denominator === 0) return 0; // Avoid division by zero\r\n\r\n        const result = ((safeRealized - safeMin) / denominator) * 100;\r\n        return Math.max(0, Math.min(100, result));\r\n      }\r\n\r\n      // Fallback if no Min is defined (Simple percentage)\r\n      if (safeTarget === 0) return 0;\r\n      const result = (safeRealized / safeTarget) * 100;\r\n      return Math.min(100, Math.max(0, result));\r\n    }\r\n\r\n    // Logic for \"Decrease\" (Menor ├® melhor)\r\n    if (direction === 'decrease' || direction === 'menor-├®-melhor') {\r\n      if (safeRealized <= safeTarget) return 100;\r\n\r\n      // Simple linear decay for now as no formula provided for decrease\r\n      if (safeTarget === 0) return 0; // Prevent div by zero\r\n      // Example: 200% - (Realized/Target)%\r\n      const result = ((2 * safeTarget - safeRealized) / safeTarget) * 100;\r\n      return Math.max(0, result);\r\n    }\r\n\r\n    return 0;\r\n  };\r\n\r\n  const updateStoredProgress = async (kr: KeyResult, newPercent: number | null) => {\r\n    if (newPercent === null || Number.isNaN(newPercent)) return;\r\n    try {\r\n      await supabase\r\n        .from('key_results')\r\n        .update({ percent_kr: newPercent })\r\n        .eq('id', kr.id);\r\n\r\n      let objectiveQuery = supabase\r\n        .from('key_results')\r\n        .select('percent_kr')\r\n        .eq('objective_id', kr.objective_id);\r\n\r\n      if (kr.company_id) {\r\n        objectiveQuery = objectiveQuery.eq('company_id', kr.company_id);\r\n      }\r\n\r\n      const { data: objectiveKRs, error: fetchError } = await objectiveQuery;\r\n\r\n      if (fetchError) throw fetchError;\r\n\r\n      const validPercents = (objectiveKRs ?? [])\r\n        .map((item) => item.percent_kr)\r\n        .filter((value): value is number => typeof value === 'number');\r\n\r\n      const objectivePercent =\r\n        validPercents.length > 0\r\n          ? Math.round(validPercents.reduce((sum, value) => sum + value, 0) / validPercents.length)\r\n          : newPercent;\r\n\r\n      const { data: objInfo } = await supabase\r\n        .from('objectives')\r\n        .update({ percent_obj: objectivePercent })\r\n        .eq('id', kr.objective_id)\r\n        .select('title, quarter_id, company_id')\r\n        .single();\r\n\r\n      // Atualiza o agregado do grupo (mesmo t├¡tulo em toda a empresa)\r\n      if (objInfo) {\r\n        const { data: allSameObjectives } = await supabase\r\n          .from('objectives')\r\n          .select('percent_obj, key_results (id)')\r\n          .eq('company_id', objInfo.company_id)\r\n          .eq('quarter_id', objInfo.quarter_id)\r\n          .eq('title', objInfo.title)\r\n          .eq('archived', false);\r\n\r\n        if (allSameObjectives) {\r\n          const totalPct = allSameObjectives.reduce((sum, o) => sum + (o.percent_obj ?? 0), 0);\r\n          const userCount = allSameObjectives.length;\r\n          const krCount = allSameObjectives.reduce((sum, o) => sum + ((o.key_results as any[])?.length || 0), 0);\r\n          const avg = Math.round(totalPct / userCount);\r\n\r\n          await supabase\r\n            .from('objective_group_results')\r\n            .upsert({\r\n              company_id: objInfo.company_id,\r\n              quarter_id: objInfo.quarter_id,\r\n              objective_title: objInfo.title,\r\n              avg_attainment_pct: avg,\r\n              kr_count: krCount,\r\n              updated_at: new Date().toISOString()\r\n            }, { onConflict: 'company_id,quarter_id,objective_title' });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Erro ao sincronizar percentuais de objetivo/KR:', error);\r\n    }\r\n  };\r\n\r\n  const parseDateOnly = (dateString: string | null | undefined) => {\r\n    if (!dateString) return null;\r\n\r\n    const [yearStr, monthStr, dayPart] = dateString.split('-');\r\n    if (!yearStr || !monthStr || !dayPart) return null;\r\n\r\n    const cleanedDay = dayPart.replace(/[^0-9].*$/, '');\r\n    const year = Number(yearStr);\r\n    const month = Number(monthStr);\r\n    const day = Number(cleanedDay);\r\n\r\n    if ([year, month, day].some((value) => Number.isNaN(value))) {\r\n      return null;\r\n    }\r\n\r\n    return new Date(year, month - 1, day);\r\n  };\r\n\r\n  const getCheckinTime = (dateString: string | null | undefined) => {\r\n    const parsed = parseDateOnly(dateString);\r\n    return parsed ? parsed.getTime() : null;\r\n  };\r\n\r\n  const handleInputChange = (krId: string, checkinId: string, field: 'meta' | 'minimo' | 'realizado', value: string) => {\r\n    const key = `${krId}-${checkinId}`;\r\n    const current = editingData[key] || { meta: '', minimo: '', realizado: '' };\r\n\r\n    setEditingData({\r\n      ...editingData,\r\n      [key]: {\r\n        ...current,\r\n        [field]: value,\r\n      }\r\n    });\r\n  };\r\n\r\n  const initializeEditingData = (krId: string, checkinId: string) => {\r\n    const key = `${krId}-${checkinId}`;\r\n    if (editingData[key]) return;\r\n\r\n    const existing = checkinResults[key];\r\n    setEditingData({\r\n      ...editingData,\r\n      [key]: {\r\n        meta: existing?.meta_checkin?.toString() || '',\r\n        minimo: existing?.minimo_orcamento?.toString() || '',\r\n        realizado: existing?.valor_realizado?.toString() || '',\r\n      }\r\n    });\r\n  };\r\n\r\n  const getInputType = (type: string | null) => {\r\n    if (type === 'moeda' || type === 'currency') return 'text';\r\n    if (type === 'percentual' || type === 'percentage' || type === 'numero' || type === 'number') return 'number';\r\n    return 'text';\r\n  };\r\n\r\n  const getInputStep = (type: string | null) => {\r\n    return type === 'moeda' ? '0.01' : '0.1';\r\n  };\r\n\r\n  const groupedObjectives = useMemo(() => {\r\n    const titleMap = new Map<string, { objectives: Objective[]; keyResults: KeyResult[] }>();\r\n    const objectiveIdToTitle = new Map<string, string>();\r\n\r\n    objectives.forEach((obj) => {\r\n      objectiveIdToTitle.set(obj.id, obj.title);\r\n      if (!titleMap.has(obj.title)) {\r\n        titleMap.set(obj.title, { objectives: [], keyResults: [] });\r\n      }\r\n      titleMap.get(obj.title)!.objectives.push(obj);\r\n    });\r\n\r\n    keyResults.forEach((kr) => {\r\n      const title = objectiveIdToTitle.get(kr.objective_id);\r\n      if (!title) return;\r\n      titleMap.get(title)?.keyResults.push(kr);\r\n    });\r\n\r\n    return Array.from(titleMap.entries())\r\n      .map(([title, data]) => ({ title, ...data }))\r\n      .filter((group) => group.keyResults.length > 0);\r\n  }, [objectives, keyResults]);\r\n\r\n  const calculateGroupAverage = useCallback((groupKRs: KeyResult[], checkinId: string) => {\r\n    let weightedSum = 0;\r\n    let totalWeight = 0;\r\n    let count = 0;\r\n\r\n    groupKRs.forEach((kr) => {\r\n      const key = `${kr.id}-${checkinId}`;\r\n      const result = checkinResults[key];\r\n\r\n      if (\r\n        result &&\r\n        result.valor_realizado !== null &&\r\n        result.meta_checkin !== null &&\r\n        result.minimo_orcamento !== null\r\n      ) {\r\n        const krPercentage = calculateKR(\r\n          result.valor_realizado,\r\n          result.minimo_orcamento,\r\n          result.meta_checkin,\r\n          kr.direction,\r\n          kr.type\r\n        );\r\n\r\n        if (krPercentage !== null) {\r\n          const weight = typeof kr.weight === 'number' && !Number.isNaN(kr.weight) ? kr.weight : 1;\r\n          weightedSum += krPercentage * weight;\r\n          totalWeight += weight;\r\n          count++;\r\n        }\r\n      }\r\n    });\r\n\r\n    return {\r\n      average: totalWeight > 0 ? Math.round(weightedSum / totalWeight) : 0,\r\n      hasData: count > 0,\r\n    };\r\n  }, [checkinResults]);\r\n\r\n  const checkinGroupAverages = useMemo(() => {\r\n    const map: Record<string, Record<string, { average: number; hasData: boolean }>> = {};\r\n\r\n    groupedObjectives.forEach((group) => {\r\n      map[group.title] = {};\r\n      quarterCheckins.forEach((checkin) => {\r\n        map[group.title][checkin.id] = calculateGroupAverage(group.keyResults, checkin.id);\r\n      });\r\n    });\r\n\r\n    return map;\r\n  }, [groupedObjectives, quarterCheckins, calculateGroupAverage]);\r\n\r\n  const checkinOverallAverages = useMemo(() => {\r\n    const map: Record<string, { average: number; hasData: boolean }> = {};\r\n\r\n    quarterCheckins.forEach((checkin) => {\r\n      let sum = 0;\r\n      let count = 0;\r\n\r\n      groupedObjectives.forEach((group) => {\r\n        const stats = checkinGroupAverages[group.title]?.[checkin.id];\r\n        if (stats?.hasData) {\r\n          sum += stats.average;\r\n          count++;\r\n        }\r\n      });\r\n\r\n      map[checkin.id] = {\r\n        average: count > 0 ? Math.round(sum / count) : 0,\r\n        hasData: count > 0,\r\n      };\r\n    });\r\n\r\n    return map;\r\n  }, [quarterCheckins, groupedObjectives, checkinGroupAverages]);\r\n\r\n  const activeCheckinId = useMemo(() => {\r\n    if (quarterCheckins.length === 0) return null;\r\n\r\n    const sorted = [...quarterCheckins].sort((a, b) => {\r\n      const timeA = getCheckinTime(a.checkin_date);\r\n      const timeB = getCheckinTime(b.checkin_date);\r\n      return (timeA ?? Number.POSITIVE_INFINITY) - (timeB ?? Number.POSITIVE_INFINITY);\r\n    });\r\n\r\n    const referenceList = sorted.filter((checkin) => getCheckinTime(checkin.checkin_date) !== null);\r\n    const orderedList = referenceList.length > 0 ? referenceList : sorted;\r\n    if (orderedList.length === 0) return null;\r\n\r\n    const now = currentDate.getTime();\r\n    const firstStart = getCheckinTime(orderedList[0].checkin_date);\r\n\r\n    if (firstStart !== null && now < firstStart) {\r\n      return orderedList[0].id;\r\n    }\r\n\r\n    for (let i = 0; i < orderedList.length; i++) {\r\n      const start = getCheckinTime(orderedList[i].checkin_date);\r\n      if (start === null) continue;\r\n      const nextStart = orderedList[i + 1] ? getCheckinTime(orderedList[i + 1].checkin_date) : null;\r\n\r\n      if (!nextStart && now >= start) {\r\n        return orderedList[i].id;\r\n      }\r\n\r\n      if (nextStart !== null && now >= start && now < nextStart) {\r\n        return orderedList[i].id;\r\n      }\r\n    }\r\n\r\n    return orderedList[orderedList.length - 1]?.id ?? null;\r\n  }, [quarterCheckins, currentDate]);\r\n\r\n  // Inicializar data selecionada com a mais recente quando quarterCheckins mudar\r\n  useEffect(() => {\r\n    if (quarterCheckins.length > 0 && !selectedCheckinDate) {\r\n      if (activeCheckinId) {\r\n        setSelectedCheckinDate(activeCheckinId);\r\n        return;\r\n      }\r\n\r\n      const sortedCheckins = [...quarterCheckins].sort((a, b) => {\r\n        const timeA = getCheckinTime(a.checkin_date);\r\n        const timeB = getCheckinTime(b.checkin_date);\r\n        return (timeB ?? Number.NEGATIVE_INFINITY) - (timeA ?? Number.NEGATIVE_INFINITY);\r\n      });\r\n      setSelectedCheckinDate(sortedCheckins[0].id);\r\n    }\r\n  }, [quarterCheckins, selectedCheckinDate, activeCheckinId]);\r\n\r\n  useEffect(() => {\r\n    if (activeCheckinId && checkinOverallAverages[activeCheckinId]) {\r\n      setCurrentResult(checkinOverallAverages[activeCheckinId].average);\r\n    } else {\r\n      setCurrentResult(0);\r\n    }\r\n  }, [activeCheckinId, checkinOverallAverages]);\r\n\r\n  useEffect(() => {\r\n    const saveQuarterResult = async () => {\r\n      if (!user || !selectedQuarter || !activeCheckinId) return;\r\n\r\n      const targetCompanyId =\r\n        filterCompanyId && filterCompanyId !== 'all'\r\n          ? filterCompanyId\r\n          : (userProfile?.company_id ?? selectedCompanyId);\r\n\r\n      const targetUserId =\r\n        role === 'user'\r\n          ? user.id\r\n          : (filterOwnerId && filterOwnerId !== 'all' ? filterOwnerId : null);\r\n\r\n      if (!targetCompanyId || !targetUserId) return;\r\n\r\n      const stats = checkinOverallAverages[activeCheckinId];\r\n      if (!stats?.hasData) return;\r\n\r\n      try {\r\n        const { data: existingResult, error } = await supabase\r\n          .from('quarter_results')\r\n          .select('id')\r\n          .eq('company_id', targetCompanyId)\r\n          .eq('user_id', targetUserId)\r\n          .eq('quarter_id', selectedQuarter)\r\n          .maybeSingle();\r\n\r\n        if (error) {\r\n          console.error('Erro ao carregar resultado do quarter:', error);\r\n          return;\r\n        }\r\n\r\n        const payload = {\r\n          result_percent: currentResult,\r\n          updated_at: new Date().toISOString(),\r\n        };\r\n\r\n        if (existingResult) {\r\n          await supabase.from('quarter_results').update(payload).eq('id', existingResult.id);\r\n        } else {\r\n          await supabase.from('quarter_results').insert({\r\n            company_id: targetCompanyId,\r\n            user_id: targetUserId,\r\n            quarter_id: selectedQuarter,\r\n            result_percent: currentResult,\r\n            saved_at: new Date().toISOString(),\r\n            updated_at: new Date().toISOString(),\r\n          });\r\n        }\r\n      } catch (error) {\r\n        console.error('Erro ao salvar resultado do quarter:', error);\r\n      }\r\n    };\r\n\r\n    saveQuarterResult();\r\n  }, [\r\n    activeCheckinId,\r\n    checkinOverallAverages,\r\n    currentResult,\r\n    selectedQuarter,\r\n    user,\r\n    userProfile,\r\n    filterOwnerId,\r\n    filterCompanyId,\r\n    selectedCompanyId,\r\n    role,\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    const persistCompletedCheckins = async () => {\r\n      if (!role || role === 'user' || quarterCheckins.length === 0) return;\r\n\r\n      const sorted = [...quarterCheckins].sort((a, b) => {\r\n        const timeA = getCheckinTime(a.checkin_date);\r\n        const timeB = getCheckinTime(b.checkin_date);\r\n        return (timeA ?? Number.POSITIVE_INFINITY) - (timeB ?? Number.POSITIVE_INFINITY);\r\n      });\r\n      const now = currentDate.getTime();\r\n      const updates: { id: string; value: number }[] = [];\r\n\r\n      for (let i = 0; i < sorted.length - 1; i++) {\r\n        const current = sorted[i];\r\n        const nextStart = getCheckinTime(sorted[i + 1].checkin_date);\r\n        if (nextStart === null) {\r\n          continue;\r\n        }\r\n        const stats = checkinOverallAverages[current.id];\r\n        const alreadySaved = current.result_percent !== null && current.result_percent !== undefined;\r\n\r\n        if (!alreadySaved && stats?.hasData && now >= nextStart) {\r\n          updates.push({ id: current.id, value: stats.average });\r\n        }\r\n      }\r\n\r\n      if (updates.length === 0) return;\r\n\r\n      try {\r\n        await Promise.all(\r\n          updates.map(async (update) => {\r\n            const { error: updateError } = await supabase\r\n              .from('checkins')\r\n              .update({\r\n                result_percent: update.value,\r\n                updated_at: new Date().toISOString(),\r\n              })\r\n              .eq('id', update.id);\r\n\r\n            if (updateError) {\r\n              throw updateError;\r\n            }\r\n          })\r\n        );\r\n\r\n        setQuarterCheckins((prev) =>\r\n          prev.map((checkin) => {\r\n            const update = updates.find((u) => u.id === checkin.id);\r\n            return update ? { ...checkin, result_percent: update.value } : checkin;\r\n          })\r\n        );\r\n      } catch (error) {\r\n        console.error('Erro ao salvar resultado do check-in:', error);\r\n      }\r\n    };\r\n\r\n    persistCompletedCheckins();\r\n  }, [quarterCheckins, checkinOverallAverages, currentDate, role]);\r\n\r\n  return (\r\n    <Layout>\r\n      <div className=\"space-y-6\">\r\n        <div className=\"flex justify-between items-center\">\r\n          <h1 className=\"text-3xl font-bold\">{toTitleCase('Check-ins de Key Results')}</h1>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n          {/* PRIMEIRO: Filtro de Empresa */}\r\n          {role === 'admin' && (\r\n            <div>\r\n              <Label htmlFor=\"company\">{toTitleCase('Empresa')}</Label>\r\n              <div className=\"h-10 px-3 flex items-center rounded-md border bg-muted/30 text-sm text-foreground\">\r\n                {selectedCompany?.name ? toTitleCase(selectedCompany.name) : toTitleCase('Nenhuma empresa selecionada')}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* SEGUNDO: Filtro de Quarter */}\r\n          <div>\r\n            <Label htmlFor=\"quarter\">{toTitleCase('Quarter')}</Label>\r\n            <Select value={selectedQuarter} onValueChange={setSelectedQuarter}>\r\n              <SelectTrigger className=\"bg-background\">\r\n                <SelectValue placeholder={toTitleCase('Selecione o quarter')} />\r\n              </SelectTrigger>\r\n              <SelectContent className=\"bg-popover z-50\">\r\n                {quarters.map((quarter) => (\r\n                  <SelectItem key={quarter.id} value={quarter.id}>\r\n                    {toTitleCase(quarter.name)}\r\n                  </SelectItem>\r\n                ))}\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n\r\n          {/* TERCEIRO: Filtro de Usu├írio */}\r\n          {role === 'admin' && (\r\n            <div>\r\n              <Label htmlFor=\"user\">{toTitleCase('Usu├írio')}</Label>\r\n              <Select\r\n                value={filterOwnerId || 'all'}\r\n                onValueChange={setFilterOwnerId}\r\n                disabled={!filterCompanyId || filterCompanyId === 'all'}\r\n              >\r\n                <SelectTrigger className=\"bg-background\">\r\n                  <SelectValue placeholder={toTitleCase('Todos os usu├írios')} />\r\n                </SelectTrigger>\r\n                <SelectContent className=\"bg-popover z-50\">\r\n                  <SelectItem value=\"all\">Todos os usu├írios</SelectItem>\r\n                  {users\r\n                    .filter((user) => user.id)\r\n                    .map((user) => (\r\n                      <SelectItem key={user.id} value={user.id}>\r\n                        {toTitleCase(user.full_name)}\r\n                      </SelectItem>\r\n                    ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {selectedQuarter && (\r\n          <Card className=\"w-fit\">\r\n            <CardContent className=\"p-6\">\r\n              <div className=\"flex items-center gap-4\">\r\n                <div>\r\n                  <p className=\"text-sm font-medium text-muted-foreground mb-1\">RESULTADO ATUAL</p>\r\n                  <p className=\"text-4xl font-bold text-primary\">{currentResult}%</p>\r\n                </div>\r\n                <Progress\r\n                  value={currentResult}\r\n                  className=\"h-3 w-32\"\r\n                  style={{ '--progress-color': getProgressColor(currentResult) } as React.CSSProperties}\r\n                />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n\r\n        {selectedQuarter && quarterCheckins.length > 0 && objectives.length > 0 && (\r\n          <Card>\r\n            <CardContent className=\"p-0\">\r\n              <div>\r\n                <Table>\r\n                  <TableHeader>\r\n                    <TableRow>\r\n                      <TableHead className=\"w-[60px] sticky left-0 bg-background z-10 text-primary font-semibold px-2\">\r\n                        {toTitleCase('C├│digo')}\r\n                      </TableHead>\r\n                      <TableHead className=\"w-[200px] sticky left-[60px] bg-background z-10 px-3\">\r\n                        {toTitleCase('Key Result')}\r\n                      </TableHead>\r\n                      {quarterCheckins.map((checkin) => (\r\n                        <TableHead\r\n                          key={checkin.id}\r\n                          className={`text-center min-w-[200px] px-4 cursor-pointer transition-colors ${selectedCheckinDate === checkin.id\r\n                            ? 'bg-primary/10 border-b-2 border-primary'\r\n                            : 'hover:bg-muted/50'\r\n                            }`}\r\n                          onClick={() => setSelectedCheckinDate(checkin.id)}\r\n                        >\r\n                          <div className={`font-bold ${selectedCheckinDate === checkin.id ? 'text-primary' : ''}`}>\r\n                            {formatDate(checkin.checkin_date)}\r\n                          </div>\r\n                          {selectedCheckinDate === checkin.id && (\r\n                            <div className=\"text-xs text-primary mt-1\">Selecionada</div>\r\n                          )}\r\n                        </TableHead>\r\n                      ))}\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {groupedObjectives.map((group) => (\r\n                      <React.Fragment key={group.title}>\r\n                        <TableRow className=\"bg-muted/50\">\r\n                          <TableCell colSpan={2} className=\"sticky left-0 bg-muted/50 z-10 px-2\">\r\n                            <div className=\"text-base font-bold text-primary uppercase py-2\">\r\n                              {toTitleCase(group.title)}\r\n                            </div>\r\n                          </TableCell>\r\n                          {quarterCheckins.map((checkin) => {\r\n                            const stats = checkinGroupAverages[group.title]?.[checkin.id];\r\n                            const avgPercentage = stats?.average ?? 0;\r\n\r\n                            return (\r\n                              <TableCell key={checkin.id} className=\"bg-muted/50 text-center px-2\">\r\n                                <div className=\"flex flex-col items-center gap-1 py-2\">\r\n                                  <span className=\"text-xl font-bold text-primary\">{avgPercentage}%</span>\r\n                                  <Progress\r\n                                    value={avgPercentage}\r\n                                    className=\"h-2 w-20\"\r\n                                    style={{ '--progress-color': getProgressColor(avgPercentage) } as React.CSSProperties}\r\n                                  />\r\n                                </div>\r\n                              </TableCell>\r\n                            );\r\n                          })}\r\n                        </TableRow>\r\n                        {group.keyResults.map((kr, index) => (\r\n                          <TableRow key={kr.id}>\r\n                            <TableCell className=\"sticky left-0 bg-background z-10 font-bold px-2\">\r\n                              KR{index + 1}\r\n                            </TableCell>\r\n                            <TableCell className=\"sticky left-[60px] bg-background z-10 px-3 min-h-[140px] w-[140px]\">\r\n                              <div className=\"flex flex-col justify-center min-h-[140px]\">\r\n                                <div className=\"text-sm font-medium uppercase whitespace-normal\">{toTitleCase(kr.title)}</div>\r\n                                <div className=\"text-xs text-muted-foreground mt-1 uppercase whitespace-nowrap\">\r\n                                  Tipo: {translateType(kr.type)} ÔÇó Dire├º├úo: {translateDirection(kr.direction)}\r\n                                </div>\r\n                              </div>\r\n                            </TableCell>\r\n                            {quarterCheckins.map((checkin) => {\r\n                              const key = `${kr.id}-${checkin.id}`;\r\n                              const result = checkinResults[key];\r\n\r\n                              return (\r\n                                <TableCell\r\n                                  key={checkin.id}\r\n                                  className=\"p-4 cursor-pointer hover:bg-muted/50 min-w-[200px]\"\r\n                                  onClick={() => openDialog(kr, checkin)}\r\n                                >\r\n                                  {result ? (\r\n                                    <div className=\"space-y-2\">\r\n                                      <div>\r\n                                        <p className=\"text-xs text-muted-foreground\">META:</p>\r\n                                        <p className=\"font-medium\">{formatValue(result.meta_checkin, kr.type, kr.unit)}</p>\r\n                                      </div>\r\n\r\n                                      <div>\r\n                                        <p className=\"text-xs text-muted-foreground\">MIN. OR├çAM:</p>\r\n                                        <p className=\"font-medium\">{formatValue(result.minimo_orcamento, kr.type, kr.unit)}</p>\r\n                                      </div>\r\n\r\n                                      {(() => {\r\n                                        const krProgress = calculateKR(\r\n                                          result.valor_realizado,\r\n                                          result.minimo_orcamento,\r\n                                          result.meta_checkin,\r\n                                          kr.direction,\r\n                                          kr.type\r\n                                        );\r\n                                        const simpleAttainment = calculateSimpleAttainment(\r\n                                          result.valor_realizado,\r\n                                          result.meta_checkin,\r\n                                          kr.direction,\r\n                                          kr.type\r\n                                        );\r\n\r\n                                        const visualAttainmentValue = (kr.type === 'date' || kr.type === 'data')\r\n                                          ? krProgress\r\n                                          : (result.percentual_atingido ?? simpleAttainment);\r\n\r\n                                        const attainmentText = visualAttainmentValue !== null ? `${visualAttainmentValue.toFixed(2)}%` : '--';\r\n                                        const krText = krProgress !== null ? `${krProgress.toFixed(2)}%` : '--';\r\n\r\n                                        const progressValue = krProgress ?? 0;\r\n                                        const progressColor = krProgress !== null ? getProgressColor(krProgress) : '#e5e7eb';\r\n\r\n                                        return (\r\n                                          <>\r\n                                            <div className=\"flex justify-between items-center\">\r\n                                              <span className=\"text-muted-foreground\">REALIZADO:</span>\r\n                                              <div className=\"text-right\">\r\n                                                <div className=\"font-bold\">{formatValue(result.valor_realizado, kr.type, kr.unit)}</div>\r\n                                                <div className=\"text-[10px] font-semibold text-[#0d3a8c]\">\r\n                                                  <span>Atingimento:</span>\r\n                                                  <span className=\"ml-1\">{attainmentText}</span>\r\n                                                </div>\r\n                                              </div>\r\n                                            </div>\r\n                                            <div className=\"space-y-1\">\r\n                                              <Progress\r\n                                                value={progressValue}\r\n                                                className=\"h-2\"\r\n                                                style={{\r\n                                                  ['--progress-color' as any]: progressColor\r\n                                                }}\r\n                                              />\r\n                                              <div className=\"flex justify-between items-center text-[10px]\">\r\n                                                <span className=\"text-muted-foreground\">KR:</span>\r\n                                                <span className=\"font-semibold text-primary text-sm\">\r\n                                                  {krText}\r\n                                                </span>\r\n                                              </div>\r\n                                            </div>\r\n                                          </>\r\n                                        );\r\n                                      })()}\r\n                                    </div>\r\n                                  ) : (\r\n                                    <Button size=\"sm\" variant=\"outline\" className=\"w-full\">\r\n                                      Cadastrar Meta\r\n                                    </Button>\r\n                                  )}\r\n                                </TableCell>\r\n                              );\r\n                            })}\r\n                          </TableRow>\r\n                        ))}\r\n                      </React.Fragment>\r\n                    ))}\r\n                  </TableBody>\r\n                </Table>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n\r\n        {selectedQuarter && (objectives.length === 0 || quarterCheckins.length === 0) && (\r\n          <Card>\r\n            <CardContent className=\"p-6 text-center text-muted-foreground\">\r\n              {quarterCheckins.length === 0\r\n                ? 'Nenhum check-in cadastrado para este trimestre'\r\n                : 'Nenhum objetivo cadastrado para este trimestre'}\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n\r\n        <Dialog open={isDialogOpen} onOpenChange={(open) => {\r\n          if (!open) {\r\n            closeDialog();\r\n          }\r\n        }}>\r\n          <DialogContent\r\n            className=\"max-w-lg max-h-[85vh] overflow-y-auto\"\r\n            onInteractOutside={(e) => e.preventDefault()}\r\n          >\r\n            <DialogHeader>\r\n              <DialogTitle>Cadastrar Meta do Check-in</DialogTitle>\r\n            </DialogHeader>\r\n\r\n            {currentKR && currentCheckin && (\r\n              <div className=\"space-y-6\">\r\n                <div className=\"space-y-2\">\r\n                  <div className=\"text-sm\">\r\n                    <span className=\"font-semibold\">Key Result:</span> {currentKR.title}\r\n                  </div>\r\n                  <div className=\"text-sm\">\r\n                    <span className=\"font-semibold\">Check-in:</span> {formatDate(currentCheckin.checkin_date)}\r\n                  </div>\r\n                  <div className=\"text-sm\">\r\n                    <span className=\"font-semibold\">Tipo:</span> {translateType(currentKR.type)}\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-6\">\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"flex justify-between items-center\">\r\n                        <Label>META:</Label>\r\n                        <span className=\"text-lg font-bold\">\r\n                          {formatValue(parseValueForType(formData.meta, currentKR.type), currentKR.type, currentKR.unit)}\r\n                        </span>\r\n                      </div>\r\n                      {currentKR.type === 'date' || currentKR.type === 'data' ? (\r\n                        <Input\r\n                          type=\"date\"\r\n                          value={formData.meta}\r\n                          onChange={(e) => setFormData({ ...formData, meta: e.target.value })}\r\n                          className=\"text-right\"\r\n                        />\r\n                      ) : (\r\n                        <Input\r\n                          type=\"text\"\r\n                          placeholder={currentKR.type === 'moeda' || currentKR.type === 'currency' ? 'Ex: R$ 1.000,00' : currentKR.type === 'percentual' || currentKR.type === 'percentage' ? 'Ex: 85%' : 'Ex: 100'}\r\n                          value={formData.meta}\r\n                          onChange={(e) => {\r\n                            const v = e.target.value;\r\n                            let formatted = v;\r\n                            if (currentKR.type === 'moeda' || currentKR.type === 'currency') {\r\n                              formatted = formatCurrencyInputLive(v);\r\n                            } else if (currentKR.type === 'percentual' || currentKR.type === 'percentage') {\r\n                              formatted = formatPercentageInputLive(v);\r\n                            } else {\r\n                              formatted = formatNumberInputLive(v);\r\n                            }\r\n                            setFormData({\r\n                              ...formData,\r\n                              meta: formatted,\r\n                            });\r\n                          }}\r\n                          onBlur={() => setFormData({ ...formData, meta: formatInputValue(formData.meta, currentKR.type) })}\r\n                          className=\"text-right\"\r\n                        />\r\n                      )}\r\n                    </div>\r\n\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"flex justify-between items-center\">\r\n                        <Label>MIN. OR├çAM:</Label>\r\n                        <span className=\"text-lg font-bold\">\r\n                          {formatValue(parseValueForType(formData.minimo, currentKR.type), currentKR.type, currentKR.unit)}\r\n                        </span>\r\n                      </div>\r\n                      {currentKR.type === 'date' || currentKR.type === 'data' ? (\r\n                        <Input\r\n                          type=\"date\"\r\n                          value={formData.minimo}\r\n                          onChange={(e) => setFormData({ ...formData, minimo: e.target.value })}\r\n                          className=\"text-right\"\r\n                        />\r\n                      ) : (\r\n                        <Input\r\n                          type=\"text\"\r\n                          placeholder={currentKR.type === 'moeda' || currentKR.type === 'currency' ? 'Ex: R$ 1.000,00' : currentKR.type === 'percentual' || currentKR.type === 'percentage' ? 'Ex: 50%' : 'Ex: 50'}\r\n                          value={formData.minimo}\r\n                          onChange={(e) => {\r\n                            const v = e.target.value;\r\n                            let formatted = v;\r\n                            if (currentKR.type === 'moeda' || currentKR.type === 'currency') {\r\n                              formatted = formatCurrencyInputLive(v);\r\n                            } else if (currentKR.type === 'percentual' || currentKR.type === 'percentage') {\r\n                              formatted = formatPercentageInputLive(v);\r\n                            } else {\r\n                              formatted = formatNumberInputLive(v);\r\n                            }\r\n                            setFormData({\r\n                              ...formData,\r\n                              minimo: formatted,\r\n                            });\r\n                          }}\r\n                          onBlur={() => setFormData({ ...formData, minimo: formatInputValue(formData.minimo, currentKR.type) })}\r\n                          className=\"text-right\"\r\n                        />\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n\r\n                  {formData.meta && formData.minimo && (\r\n                    (() => {\r\n                      const realizedVal = parseValueForType(formData.realizado, currentKR.type);\r\n                      const minVal = parseValueForType(formData.minimo, currentKR.type);\r\n                      const metaVal = parseValueForType(formData.meta, currentKR.type);\r\n                      const progress = formData.realizado\r\n                        ? calculateKR(realizedVal, minVal, metaVal, currentKR.direction, currentKR.type)\r\n                        : null;\r\n\r\n                      const simpleAttainment = formData.realizado\r\n                        ? calculateSimpleAttainment(realizedVal, metaVal, currentKR.direction, currentKR.type)\r\n                        : null;\r\n\r\n                      const visualAttainmentValue = (currentKR.type === 'date' || currentKR.type === 'data')\r\n                        ? progress\r\n                        : simpleAttainment;\r\n\r\n                      const attainmentText = visualAttainmentValue !== null ? `${visualAttainmentValue.toFixed(2)}%` : '--';\r\n                      const krText = progress !== null ? `${progress.toFixed(2)}%` : '--';\r\n\r\n                      const progressValue = progress ?? 0;\r\n                      const progressColor = progress !== null ? getProgressColor(progress) : '#e5e7eb';\r\n\r\n                      return (\r\n                        <div className=\"space-y-3\">\r\n                          <div className=\"flex justify-between items-center\">\r\n                            <Label>REALIZADO:</Label>\r\n                            <div className=\"text-right\">\r\n                              <div className=\"text-lg font-bold\">\r\n                                {formatValue(formData.realizado ? realizedVal : null, currentKR.type, currentKR.unit)}\r\n                              </div>\r\n                              {formData.realizado && (\r\n                                <div className=\"text-sm space-y-1\">\r\n                                  <div className=\"font-semibold text-[#0d3a8c]\">\r\n                                    <span>Atingimento:</span>\r\n                                    <span className=\"ml-1\">{attainmentText}</span>\r\n                                  </div>\r\n                                  <div className=\"font-semibold text-primary text-sm\">\r\n                                    KR: {krText}\r\n                                  </div>\r\n                                </div>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                          <Progress\r\n                            value={progressValue}\r\n                            className=\"h-3\"\r\n                            style={{ ['--progress-color' as any]: progressColor }}\r\n                          />\r\n                          {currentKR.type === 'date' || currentKR.type === 'data' ? (\r\n                            <Input\r\n                              type=\"date\"\r\n                              value={formData.realizado}\r\n                              onChange={(e) => setFormData({ ...formData, realizado: e.target.value })}\r\n                              className=\"mt-2 text-right\"\r\n                            />\r\n                          ) : (\r\n                            <Input\r\n                              type=\"text\"\r\n                              placeholder={\r\n                                currentKR.type === 'moeda' || currentKR.type === 'currency'\r\n                                  ? 'Ex: R$ 1.000,00'\r\n                                  : currentKR.type === 'percentual' || currentKR.type === 'percentage'\r\n                                    ? 'Ex: 75%'\r\n                                    : 'Ex: 1000'\r\n                              }\r\n                              value={formData.realizado}\r\n                              onChange={(e) => {\r\n                                const v = e.target.value;\r\n                                let formatted = v;\r\n                                if (currentKR.type === 'moeda' || currentKR.type === 'currency') {\r\n                                  formatted = formatCurrencyInputLive(v);\r\n                                } else if (currentKR.type === 'percentual' || currentKR.type === 'percentage') {\r\n                                  formatted = formatPercentageInputLive(v);\r\n                                } else {\r\n                                  formatted = formatNumberInputLive(v);\r\n                                }\r\n                                setFormData({ ...formData, realizado: formatted });\r\n                              }}\r\n                              onBlur={() =>\r\n                                setFormData({\r\n                                  ...formData,\r\n                                  realizado: formatInputValue(formData.realizado, currentKR.type),\r\n                                })\r\n                              }\r\n                              className=\"mt-2 text-right\"\r\n                            />\r\n                          )}\r\n                        </div>\r\n                      );\r\n                    })()\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"observacoes\">Observa├º├Áes</Label>\r\n                  <textarea\r\n                    id=\"observacoes\"\r\n                    placeholder=\"Digite suas observa├º├Áes sobre este check-in...\"\r\n                    value={formData.observacoes}\r\n                    onChange={(e) => setFormData({ ...formData, observacoes: e.target.value })}\r\n                    className=\"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\r\n                    rows={3}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex gap-3\">\r\n                  <Button\r\n                    type=\"button\"\r\n                    onClick={(e) => {\r\n                      e.preventDefault();\r\n                      e.stopPropagation();\r\n                      handleSaveCheckin(e);\r\n                    }}\r\n                    className=\"flex-1\"\r\n                  >\r\n                    Salvar\r\n                  </Button>\r\n                  <Button\r\n                    type=\"button\"\r\n                    onClick={(e) => {\r\n                      e.preventDefault();\r\n                      e.stopPropagation();\r\n                      closeDialog();\r\n                    }}\r\n                    variant=\"outline\"\r\n                    className=\"flex-1\"\r\n                  >\r\n                    Cancelar\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </DialogContent>\r\n        </Dialog>\r\n      </div>\r\n    </Layout>\r\n  );\r\n}\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"F:\\WendelWenKey\\src\\pages\\PerformanceHistory.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":81,"column":8,"nodeType":"ArrayExpression","endLine":81,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [filterCompanyId, loadData]","fix":{"range":[2202,2219],"text":"[filterCompanyId, loadData]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":131,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4121,4124],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4121,4124],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'getUserAverage'. Either include it or remove the dependency array.","line":173,"column":8,"nodeType":"ArrayExpression","endLine":173,"endColumn":41,"suggestions":[{"desc":"Update the dependencies array to be: [activeUsersOnly, users, getUserAverage]","fix":{"range":[5564,5597],"text":"[activeUsersOnly, users, getUserAverage]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { Layout } from '@/components/Layout';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport {\r\n    Table,\r\n    TableBody,\r\n    TableCell,\r\n    TableHead,\r\n    TableHeader,\r\n    TableRow,\r\n} from '@/components/ui/table';\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from '@/components/ui/select';\r\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Trophy, TrendingUp } from 'lucide-react';\r\nimport { useState, useEffect, useMemo } from 'react';\r\nimport { supabase } from '@/integrations/supabase/client';\r\nimport { useCompany } from '@/contexts/CompanyContext';\r\nimport { useUserRole } from '@/hooks/useUserRole';\r\nimport { toast } from 'sonner';\r\nimport { toTitleCase } from '@/lib/utils';\r\n\r\ninterface Company {\r\n    id: string;\r\n    name: string;\r\n}\r\n\r\ninterface Quarter {\r\n    id: string;\r\n    name: string;\r\n    start_date: string;\r\n    end_date: string;\r\n    is_active: boolean;\r\n}\r\n\r\ninterface UserProfile {\r\n    id: string;\r\n    full_name: string;\r\n    avatar_url: string | null;\r\n    sector: string | null;\r\n    is_active: boolean;\r\n    company_id: string;\r\n}\r\n\r\ninterface QuarterResult {\r\n    quarter_id: string;\r\n    user_id: string;\r\n    result_percent: number;\r\n}\r\n\r\nexport default function PerformanceHistory() {\r\n    const { selectedCompanyId, selectedCompany } = useCompany();\r\n    const { isAdmin } = useUserRole();\r\n    const [loading, setLoading] = useState(true);\r\n    const [activeUsersOnly, setActiveUsersOnly] = useState(true);\r\n\r\n    // Data State\r\n    const [quarters, setQuarters] = useState<Quarter[]>([]);\r\n    const [users, setUsers] = useState<UserProfile[]>([]);\r\n    const [results, setResults] = useState<QuarterResult[]>([]);\r\n\r\n    // Admin Filter State\r\n    const [filterCompanyId, setFilterCompanyId] = useState<string>(\"\");\r\n\r\n    useEffect(() => {\r\n        if (selectedCompanyId) {\r\n            setFilterCompanyId(selectedCompanyId);\r\n        }\r\n    }, [selectedCompanyId]);\r\n\r\n    useEffect(() => {\r\n        if (filterCompanyId) {\r\n            loadData();\r\n        }\r\n    }, [filterCompanyId]);\r\n\r\n    useEffect(() => {\r\n        // Remove direct dependency on selectedCompanyId for loadData\r\n        // because we want to update filterCompanyId first\r\n    }, []);\r\n\r\n    const loadData = async () => {\r\n        try {\r\n            setLoading(true);\r\n\r\n            // 1. Fetch Quarters (sorted by date)\r\n            const { data: quartersData, error: quartersError } = await supabase\r\n                .from('quarters')\r\n                .select('*')\r\n                .eq('company_id', filterCompanyId)\r\n                .order('start_date', { ascending: true });\r\n\r\n            if (quartersError) throw quartersError;\r\n            setQuarters(quartersData || []);\r\n\r\n            // 2. Fetch Users\r\n            const { data: usersData, error: usersError } = await supabase\r\n                .from('profiles')\r\n                .select('id, full_name, avatar_url, sector, is_active, company_id')\r\n                .eq('company_id', filterCompanyId)\r\n                .order('full_name');\r\n\r\n            if (usersError) throw usersError;\r\n\r\n            const normalizedUsers = (usersData || []).map(u => {\r\n                let avatarUrl = u.avatar_url;\r\n                if (avatarUrl && !avatarUrl.startsWith('http')) {\r\n                    const { data } = supabase.storage.from('avatars').getPublicUrl(avatarUrl);\r\n                    avatarUrl = data.publicUrl;\r\n                }\r\n                return { ...u, avatar_url: avatarUrl };\r\n            });\r\n\r\n            setUsers(normalizedUsers);\r\n\r\n            // 3. Fetch Quarter Results\r\n            const { data: resultsData, error: resultsError } = await supabase\r\n                .from('quarter_results')\r\n                .select('quarter_id, user_id, result_percent')\r\n                .eq('company_id', filterCompanyId);\r\n\r\n            if (resultsError) throw resultsError;\r\n            setResults(resultsData || []);\r\n\r\n        } catch (error: any) {\r\n            console.error('Error loading history:', error);\r\n            toast.error('Erro ao carregar hist├│rico de performance');\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // Helper to get result for a specific cell\r\n    const getResult = (userId: string, quarterId: string) => {\r\n        return results.find(r => r.user_id === userId && r.quarter_id === quarterId);\r\n    };\r\n\r\n    // Helper to calculate average for a user\r\n    const getUserAverage = (userId: string) => {\r\n        const userResults = results.filter(r => r.user_id === userId);\r\n        if (userResults.length === 0) return 0;\r\n\r\n        const sum = userResults.reduce((acc, curr) => acc + (curr.result_percent || 0), 0);\r\n        return Math.round(sum / userResults.length);\r\n    };\r\n\r\n    const getPerformanceColor = (pct: number) => {\r\n        return 'text-black font-normal';\r\n    };\r\n\r\n    const getInitials = (name: string) => {\r\n        return name\r\n            .split(' ')\r\n            .map(part => part[0])\r\n            .join('')\r\n            .toUpperCase()\r\n            .slice(0, 2);\r\n    };\r\n\r\n    const sortedAndFilteredUsers = useMemo(() => {\r\n        const list = activeUsersOnly ? users.filter(u => u.is_active) : [...users];\r\n        return list.sort((a, b) => {\r\n            const avgA = getUserAverage(a.id);\r\n            const avgB = getUserAverage(b.id);\r\n            return avgB - avgA;\r\n        });\r\n    }, [users, activeUsersOnly, results]);\r\n\r\n    const effectiveCompanyId = isAdmin ? filterCompanyId : selectedCompanyId;\r\n\r\n    if (!effectiveCompanyId) {\r\n        return (\r\n            <Layout>\r\n                <div className=\"flex h-[50vh] items-center justify-center text-muted-foreground\">\r\n                    Selecione uma empresa para visualizar o hist├│rico.\r\n                </div>\r\n            </Layout>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <Layout>\r\n            <div className=\"space-y-8\">\r\n                <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\r\n                    <div>\r\n                        <h1 className=\"text-3xl font-bold flex items-center gap-2\">\r\n                            <TrendingUp className=\"h-8 w-8\" />\r\n                            {toTitleCase('Hist├│rico de Performance')}\r\n                        </h1>\r\n                        <p className=\"text-base font-normal text-black\">\r\n                            {toTitleCase('Acompanhamento de resultados por quarter e m├®dia anual dos colaboradores.')}\r\n                        </p>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center gap-2\">\r\n                        {isAdmin && (\r\n                            <div className=\"w-[240px] h-10 px-3 flex items-center rounded-md border bg-muted/30 text-sm text-foreground\">\r\n                                {selectedCompany?.name ? toTitleCase(selectedCompany.name) : toTitleCase('Nenhuma empresa selecionada')}\r\n                            </div>\r\n                        )}\r\n                        <Select\r\n                            value={activeUsersOnly ? \"active\" : \"all\"}\r\n                            onValueChange={(v) => setActiveUsersOnly(v === \"active\")}\r\n                        >\r\n                            <SelectTrigger className=\"w-[180px]\">\r\n                                <SelectValue placeholder={toTitleCase('Filtro de usu├írios')} />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                                <SelectItem value=\"active\">{toTitleCase('Apenas Ativos')}</SelectItem>\r\n                                <SelectItem value=\"all\">{toTitleCase('Todos os Usu├írios')}</SelectItem>\r\n                            </SelectContent>\r\n                        </Select>\r\n                    </div>\r\n                </div>\r\n\r\n                <Card>\r\n                    <CardHeader>\r\n                        <CardTitle className=\"flex items-center gap-2\">\r\n                            <Trophy className=\"h-5 w-5\" />\r\n                            {toTitleCase('Tabela de Resultados')}\r\n                        </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                        {loading ? (\r\n                            <div className=\"flex justify-center py-12\">\r\n                                <div className=\"h-8 w-8 animate-spin rounded-full border-4 border-primary/30 border-t-primary\"></div>\r\n                            </div>\r\n                        ) : sortedAndFilteredUsers.length === 0 ? (\r\n                            <div className=\"text-center py-8 text-base font-normal text-muted-foreground\">\r\n                                {toTitleCase('Nenhum colaborador encontrado.')}\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"overflow-x-auto\">\r\n                                <Table>\r\n                                    <TableHeader>\r\n                                        <TableRow>\r\n                                            <TableHead className=\"w-[300px] text-black\">{toTitleCase('Colaborador')}</TableHead>\r\n                                            {quarters.map(quarter => (\r\n                                                <TableHead key={quarter.id} className=\"text-center min-w-[100px] text-black\">\r\n                                                    <div>{toTitleCase(quarter.name)}</div>\r\n                                                    <div className=\"text-xs font-normal text-black\">\r\n                                                        {new Date(quarter.end_date).toLocaleDateString()}\r\n                                                    </div>\r\n                                                </TableHead>\r\n                                            ))}\r\n                                            <TableHead className=\"text-center font-normal bg-muted/30 w-[120px] text-base text-black\">\r\n                                                {toTitleCase('M├®dia Geral')}\r\n                                            </TableHead>\r\n                                        </TableRow>\r\n                                    </TableHeader>\r\n                                    <TableBody>\r\n                                        {sortedAndFilteredUsers.map(user => {\r\n                                            const avg = getUserAverage(user.id);\r\n                                            return (\r\n                                                <TableRow key={user.id}>\r\n                                                    <TableCell>\r\n                                                        <div className=\"flex items-center gap-3\">\r\n                                                            <Avatar>\r\n                                                                <AvatarImage src={user.avatar_url || undefined} />\r\n                                                                <AvatarFallback>{getInitials(user.full_name)}</AvatarFallback>\r\n                                                            </Avatar>\r\n                                                            <div>\r\n                                                                <div className=\"text-base font-normal\">{toTitleCase(user.full_name)}</div>\r\n                                                                {user.sector && (\r\n                                                                    <div className=\"text-sm text-black\">{toTitleCase(user.sector)}</div>\r\n                                                                )}\r\n                                                            </div>\r\n                                                        </div>\r\n                                                    </TableCell>\r\n\r\n                                                    {quarters.map(quarter => {\r\n                                                        const result = getResult(user.id, quarter.id);\r\n                                                        return (\r\n                                                            <TableCell key={quarter.id} className=\"text-center text-base font-normal\">\r\n                                                                {result ? (\r\n                                                                    <span className={getPerformanceColor(result.result_percent).replace('font-bold', 'font-normal')}>\r\n                                                                        {Math.round(result.result_percent)}%\r\n                                                                    </span>\r\n                                                                ) : (\r\n                                                                    <span className=\"text-black\">-</span>\r\n                                                                )}\r\n                                                            </TableCell>\r\n                                                        );\r\n                                                    })}\r\n\r\n                                                    <TableCell className=\"text-center bg-muted/30\">\r\n                                                        {avg > 0 ? (\r\n                                                            <Badge variant=\"outline\" className={`${getPerformanceColor(avg).replace('font-bold', 'font-normal')} border-current text-base font-normal`}>\r\n                                                                {avg}%\r\n                                                            </Badge>\r\n                                                        ) : (\r\n                                                            <span className=\"text-muted-foreground text-base\">-</span>\r\n                                                        )}\r\n                                                    </TableCell>\r\n                                                </TableRow>\r\n                                            );\r\n                                        })}\r\n                                    </TableBody>\r\n                                </Table>\r\n                            </div>\r\n                        )}\r\n                    </CardContent>\r\n                </Card>\r\n            </div>\r\n        </Layout>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]}]
